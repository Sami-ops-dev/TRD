<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faynalytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Inter font for better readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light, clean background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for scrolling */
            min-height: 100vh;
            padding: 32px; /* Generous overall padding */
        }
        .container {
            background-color: #ffffff;
            padding: 4rem; /* Even more generous padding */
            border-radius: 2rem; /* Significantly more rounded corners */
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); /* Darker, more prominent shadow */
            width: 100%;
            max-width: 1200px;
            border: 1px solid #2d3748; /* Darker subtle border */
        }
        h1 {
            /* Professional and  title styling */
            font-size: 3.8rem; /* Even larger, more impactful title */
            font-weight: 900; /* Extra bold */
            margin-bottom: 2.5rem; /* More space below title */
            text-align: center;
            letter-spacing: -0.04em; /* Tighter letter spacing */
            
            /* Gradient text effect */
            background: linear-gradient(45deg, #7f58af, #4299e1); /* Purple to Blue gradient  */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent; /* Fallback for non-webkit browsers */
            
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle text shadow */
        }
        h2 {
            color: #2d3748;
            font-size: 2.5rem; /* Larger section titles */
            font-weight: 700;
            margin-bottom: 2rem; /* More space */
            text-align: center;
        }
        h3 {
            color: #4a5568;
            font-size: 1.875rem; /* Slightly larger sub-titles */
            font-weight: 600;
            margin-bottom: 1.5rem; /* More space */
            text-align: center;
        }
        label {
            display: block;
            margin-bottom: 0.75rem; /* More space */
            color: #4a5568;
            font-weight: 600;
            font-size: 1rem; /* Slightly larger label font */
        }
        input[type="number"], input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 1.125rem; /* More padding for inputs */
            margin-bottom: 1.75rem; /* More space below inputs */
            border: 1px solid #cbd5e0; /* Softer border */
            border-radius: 0.85rem; /* More rounded */
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.08); /* More pronounced inner shadow */
            transition: all 0.3s ease-out; /* Smoother transition */
        }
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            border-color: #7f58af; /*  purple */
            box-shadow: 0 0 0 6px rgba(127, 88, 175, 0.3); /* Larger, softer focus ring */
            outline: none;
        }
        button {
            width: 100%;
            padding: 1.25rem 2rem; /* More padding for buttons */
            color: white;
            font-weight: 700;
            border-radius: 1.25rem; /* More rounded */
            border: none;
            cursor: pointer;
            transition: all 0.3s ease-out; /* Smoother transition */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15); /* Stronger, softer shadow */
            letter-spacing: 0.03em; /* Slightly wider letter spacing */
        }
        button:hover {
            transform: translateY(-5px); /* More noticeable lift */
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); /* Even larger shadow on hover */
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #7f58af; /*  purple */
        }
        .btn-primary:hover {
            background-color: #6c4e95; /* Darker purple on hover */
        }
        .btn-secondary {
            background-color: #48bb78; /* Brighter green */
        }
        .btn-secondary:hover {
            background-color: #38a169;
        }
        .btn-danger {
            background-color: #f56565; /* Brighter red */
        }
        .btn-danger:hover {
            background-color: #e53e3e;
        }
        .btn-info {
            background-color: #4299e1; /* Brighter info blue */
        }
        .btn-info:hover {
            background-color: #3182ce;
        }
        .result-box {
            background-color: #e0f2fe; /* Lighter blue */
            padding: 1.75rem; /* More padding */
            border-radius: 1rem; /* More rounded */
            margin-top: 1.75rem; /* More margin */
            border: 1px solid #90cdf4;
            color: #2c5282;
            font-weight: 600;
            text-align: center;
            box-shadow: inset 0 1px 5px rgba(0, 0, 0, 0.08); /* More pronounced inner shadow */
            display: none;
        }
        .result-box.show {
            display: block;
        }
        .error-message {
            color: #c53030; /* Darker red for errors */
            background-color: #fed7d7;
            padding: 1rem; /* More padding */
            border-radius: 0.75rem; /* More rounded */
            margin-bottom: 1.5rem; /* More space */
            text-align: center;
            font-weight: 600;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .journal-entry {
            background-color: #f7fafc; /* Very light blue-gray */
            padding: 1.5rem; /* More padding */
            border-radius: 1rem; /* More rounded */
            border: 1px solid #e2e8f0;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Softer shadow */
            position: relative;
            transition: transform 0.2s ease-out;
        }
        .journal-entry:hover {
            transform: translateY(-3px); /* More noticeable lift */
        }
        .journal-entry p {
            margin-bottom: 0.35rem; /* More space */
        }
        .journal-entry .label {
            font-weight: 600;
            color: #4a5568;
        }
        .journal-entry .value {
            color: #2d3748;
        }
        .journal-entry .result-positive {
            color: #10b981; /* Emerald green */
            font-weight: 700;
        }
        .journal-entry .result-negative {
            color: #ef4444; /* Red */
            font-weight: 700;
        }
        .journal-actions {
            display: flex;
            gap: 0.85rem; /* More space between buttons */
            margin-top: 1.25rem; /* More space */
            justify-content: flex-end;
        }
        .journal-actions button {
            width: auto;
            padding: 0.75rem 1.5rem; /* Adjusted padding */
            font-size: 1rem; /* Slightly larger font */
            border-radius: 0.75rem; /* More rounded */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Subtle shadow for action buttons */
        }
        .journal-actions button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        /* Styles for performance dashboard */
        .performance-metric {
            background-color: #ebf8ff; /* Lighter blue */
            padding: 1.5rem; /* More padding */
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Softer shadow */
            transition: transform 0.2s ease-out;
        }
        .performance-metric:hover {
            transform: translateY(-3px);
        }
        .performance-metric p {
            margin-bottom: 0.35rem;
            color: #4a5568;
        }
        .performance-metric .value {
            font-size: 2rem; /* Larger font size */
            font-weight: 700;
            color: #2b6cb0; /* Darker blue */
        }
        .performance-metric.positive .value {
            color: #10b981; /* Green for gains */
        }
        .performance-metric.negative .value {
            color: #ef4444; /* Red for losses */
        }
        .detailed-stats-card {
            background-color: #f7fafc; /* Lighter background */
            padding: 2rem; /* More padding */
            border-radius: 1.25rem; /* More rounded */
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Softer, larger shadow */
            margin-bottom: 2rem; /* More margin */
            transition: transform 0.2s ease-out;
        }
        .detailed-stats-card:hover {
            transform: translateY(-3px);
        }
        .detailed-stats-card h4 {
            font-size: 1.5rem; /* Slightly larger */
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1.25rem; /* More margin */
            text-align: center;
        }
        .detailed-stats-card table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .detailed-stats-card th, .detailed-stats-card td {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .detailed-stats-card th {
            background-color: #e2e8f0; /* Slightly darker header */
            font-weight: 600;
            color: #4a5568;
        }
        .detailed-stats-card td {
            color: #2d3748;
        }
        .detailed-stats-card tr:nth-child(even) {
            background-color: #edf2f7; /* Slightly darker even rows */
        }
        .detailed-stats-card .positive-text {
            color: #10b981;
            font-weight: 600;
        }
        .detailed-stats-card .negative-text {
            color: #ef4444;
            font-weight: 600;
        }
        /* Specific styles for chart containers */
        .chart-container {
            position: relative;
            height: 350px; /* Increased height for charts */
            width: 100%;
            margin-bottom: 2rem; /* More margin */
            border: 1px solid #cbd5e0;
            border-radius: 1rem; /* More rounded */
            background-color: #ffffff;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }
        /* Ensure tables are scrollable on smaller screens */
        .overflow-x-auto {
            overflow-x: auto;
        }
        /* Trading Session Status styles */
        .session-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 columns on small screens */
            gap: 1rem; /* Increased gap */
            margin-top: 2rem; /* More margin */
        }
        @media (min-width: 640px) { /* sm breakpoint */
            .session-status-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 columns on larger screens */
            }
        }
        .session-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem; /* More padding */
            border-radius: 0.85rem; /* More rounded */
            background-color: #f7fafc; /* Lighter background */
            font-size: 1rem; /* Slightly larger font */
            color: #4a5568;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Subtle shadow */
            transition: transform 0.15s ease-out;
        }
        .session-item:hover {
            transform: translateY(-2px);
        }
        .session-item .status-indicator {
            width: 16px; /* Larger indicator */
            height: 16px;
            border-radius: 50%;
            margin-bottom: 0.4rem; /* More space */
            border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
        }
        .session-item.open .status-indicator {
            background-color: #48bb78; /* Brighter green for open */
        }
        .session-item.closed .status-indicator {
            background-color: #f56565; /* Brighter red for closed */
        }
        /* Styles for the session overlap chart */
        #tradingSessionsChartCanvas {
            border: 1px solid #cbd5e0;
            border-radius: 0.75rem; /* More rounded */
            background-color: #ffffff;
        }

        /* Goal Tracker styles */
        .goal-progress-bar-container {
            width: 100%;
            background-color: #e2e8f0;
            border-radius: 0.75rem; /* More rounded */
            overflow: hidden;
            margin-top: 1.5rem; /* More margin */
        }
        .goal-progress-bar {
            height: 28px; /* Taller bar */
            background-color: #7f58af; /*  purple */
            width: 0%;
            border-radius: 0.75rem;
            text-align: center;
            color: white;
            font-weight: 700;
            line-height: 28px;
            transition: width 0.5s ease-out, background-color 0.3s ease-out;
            font-size: 0.95rem; /* Slightly larger font */
        }
        .goal-progress-bar.achieved {
            background-color: #48bb78; /* Brighter green when achieved */
        }
        .goal-progress-bar-container + .result-box {
            margin-top: 1rem; /* Closer to the bar */
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-10"> <!-- More margin bottom -->
            <h1 class="text-indigo-700 mb-4">Faynalytics</h1> <!-- Changed title to Faynalytics -->
            <p class="text-gray-600 text-lg">Manage your risk and track your performance.</p> <!-- Larger text -->
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Position Size Calculator -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-gray-800 mb-6">Position Size Calculator</h2>
                <div id="calcErrorMessage" class="error-message"></div>
                <div class="space-y-4">
                    <div>
                        <label for="capital">Account Capital (€) :</label>
                        <input type="number" id="capital" value="10000" min="1" step="any">
                    </div>
                    <div>
                        <label for="riskPercentage">Risk Percentage per Trade (%) :</label>
                        <input type="number" id="riskPercentage" value="1" min="0.1" max="10" step="0.1">
                    </div>
                    <div>
                        <label for="currencyPair">Currency Pair / Asset :</label>
                        <select id="currencyPair">
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="XAUUSD">Gold (XAU/USD)</option>
                            <option value="DAX40">DAX 40 (Germany)</option>
                            <option value="SP500">S&P 500 (USA)</option>
                            <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                            <option value="CAC40">CAC 40 (France)</option>
                            <option value="custom">Other (enter pip value)</option>
                        </select>
                    </div>
                    <div id="customPipValueContainer" style="display: none;">
                        <label for="customPipValue">Pip/Point Value per Standard Lot (€) :</label>
                        <input type="number" id="customPipValue" value="10" min="0.01" step="any">
                    </div>

                    <div>
                        <label for="stopLossInputMethod">Stop Loss Input Method :</label>
                        <select id="stopLossInputMethod">
                            <option value="pips_direct">Enter Pips Directly</option>
                            <option value="price_based">Calculate Pips from Price</option>
                        </select>
                    </div>

                    <div id="pipsDirectInputContainer">
                        <label for="stopLossPips">Stop Loss (in Pips) :</label>
                        <input type="number" id="stopLossPips" value="20" min="1" step="any">
                    </div>

                    <div id="priceBasedInputContainer" style="display: none;">
                        <div>
                            <label for="entryPrice">Entry Price :</label>
                            <input type="number" id="entryPrice" step="any">
                        </div>
                        <div>
                            <label for="stopLossPrice">Stop Loss Price :</label>
                            <input type="number" id="stopLossPrice" step="any">
                        </div>
                        <div>
                            <label for="tradeTypeForSL">Trade Type :</label>
                            <select id="tradeTypeForSL">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="calculatePositionSize()" class="btn-primary">Calculate Position Size</button>
                    <div id="resultBox" class="result-box">
                        <p>Recommended Position Size : <span id="lotSize"></span> lots</p>
                        <p>Pip/Point Value : <span id="pipValueDisplay"></span> €</p>
                        <p>Amount Risked : <span id="amountRisqued"></span> €</p>
                        <p id="calculatedPipsDisplay" style="display:none;">Calculated Pips: <span id="calculatedPips"></span></p>
                    </div>
                </div>

                <!-- Global Performance Statistics Dashboard -->
                <h2 class="text-gray-800 mb-6 mt-8">Global Performance Statistics</h2>
                <div id="performanceDashboard" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-center">
                    <div class="performance-metric">
                        <p>Total Trades</p>
                        <p id="totalTrades" class="value">0</p>
                    </div>
                    <div class="performance-metric positive">
                        <p>Winning Trades</p>
                        <p id="winningTrades" class="value">0</p>
                    </div>
                    <div class="performance-metric negative">
                        <p>Losing Trades</p>
                        <p id="losingTrades" class="value">0</p>
                    </div>
                    <div class="performance-metric">
                        <p>Win Rate</p>
                        <p id="winRate" class="value">0.00%</p>
                    </div>
                    <div class="performance-metric" id="totalPnLMetric">
                        <p>Total P&L (€)</p>
                        <p id="totalPnL" class="value">0.00 €</p>
                    </div>
                    <div class="performance-metric" id="totalPnLPercentageMetric">
                        <p>Total P&L (%)</p>
                        <p id="totalPnLPercentage" class="value">0.00%</p>
                    </div>
                    <div class="performance-metric" id="avgPnLMetric">
                        <p>Avg P&L per Trade (€)</p>
                        <p id="avgPnL" class="value">0.00 €</p>
                    </div>
                    <div class="performance-metric positive">
                        <p>Largest Win (€)</p>
                        <p id="largestWin" class="value">0.00 €</p>
                    </div>
                    <div class="performance-metric negative">
                        <p>Largest Loss (€)</p>
                        <p id="largestLoss" class="value">0.00 €</p>
                    </div>
                </div>

                <!-- Performance Goal Tracker -->
                <h3 class="text-gray-800 mb-4 mt-8">Performance Goal Tracker</h3>
                <div id="goalTrackerErrorMessage" class="error-message"></div>
                <div class="space-y-4">
                    <div>
                        <label for="initialCapital">Initial Capital (€) :</label>
                        <input type="number" id="initialCapital" value="10000" min="1" step="any">
                    </div>
                    <div>
                        <label for="targetPnLEuro">Target P&L (€) :</label>
                        <input type="number" id="targetPnLEuro" value="1000" min="0.01" step="any">
                    </div>
                    <div>
                        <button onclick="setPerformanceGoal()" class="btn-primary">Set Goal</button>
                    </div>
                    <div id="goalProgressDisplay" class="result-box">
                        <p>Current Progress : <span id="currentGoalProgress">0.00%</span></p>
                        <div class="goal-progress-bar-container">
                            <div id="goalProgressBar" class="goal-progress-bar"></div>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Note: Progress is calculated based on "Total P&L (€)" and "Target P&L (€)". "Initial Capital (€)" is for context.</p>
                    </div>
                </div>

                <!-- Trading Session Status -->
                <h3 class="text-gray-800 mb-4 mt-8">Trading Session Status (UTC)</h3>
                <div id="sessionStatus" class="session-status-grid mb-4">
                    <div class="session-item">
                        <div id="londonStatus" class="status-indicator"></div>
                        <span>London</span>
                    </div>
                    <div class="session-item">
                        <div id="newYorkStatus" class="status-indicator"></div>
                        <span>New York</span>
                    </div>
                    <div class="session-item">
                        <div id="tokyoStatus" class="status-indicator"></div>
                        <span>Tokyo</span>
                    </div>
                    <div class="session-item">
                        <div id="sydneyStatus" class="status-indicator"></div>
                        <span>Sydney</span>
                    </div>
                </div>
                <!-- Canvas for session overlap visualization -->
                <div class="chart-container" style="height: 200px;">
                    <canvas id="tradingSessionsChartCanvas"></canvas>
                </div>
            </section>

            <!-- Trading Journal -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-gray-800 mb-6">Trading Journal</h2>
                <div id="journalErrorMessage" class="error-message"></div>
                <form id="journalForm" class="space-y-4 mb-8">
                    <div>
                        <label for="journalDate">Date :</label>
                        <input type="date" id="journalDate" required>
                    </div>
                    <div>
                        <label for="journalAssetSelect">Asset :</label>
                        <select id="journalAssetSelect">
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="XAUUSD">Gold (XAU/USD)</option>
                            <option value="DAX40">DAX 40 (Germany)</option>
                            <option value="SP500">S&P 500 (USA)</option>
                            <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                            <option value="CAC40">CAC 40 (France)</option>
                            <option value="other">Other (enter name)</option>
                        </select>
                        <input type="text" id="journalAssetCustom" placeholder="Enter asset name" style="display:none; margin-top: 0.5rem;">
                    </div>
                    <div>
                        <label for="journalTradeType">Trade Type :</label>
                        <select id="journalTradeType">
                            <option value="Buy">Buy (Long)</option>
                            <option value="Sell">Sell (Short)</option>
                        </select>
                    </div>
                    <div>
                        <label for="journalSetup">Setup :</label>
                        <input type="text" id="journalSetup" placeholder="Ex: Resistance breakout, MA rejection">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="journalEntryPrice">Entry :</label>
                            <input type="number" id="journalEntryPrice" step="any" required>
                        </div>
                        <div>
                            <label for="journalSL">SL :</label>
                            <input type="number" id="journalSL" step="any" required>
                        </div>
                        <div>
                            <label for="journalTP">TP :</label>
                            <input type="number" id="journalTP" step="any" required>
                        </div>
                    </div>
                    <div>
                        <label for="journalRRR">RRR (Ex: 1:2) :</label>
                        <input type="text" id="journalRRR" placeholder="Ex: 1:2">
                    </div>
                    <div>
                        <label for="journalPositionSize">Position Size :</label>
                        <input type="number" id="journalPositionSize" step="any" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="journalResultEuro">Result (€) :</label>
                            <input type="number" id="journalResultEuro" step="any"> <!-- No longer required -->
                        </div>
                        <div>
                            <label for="journalResultPercentage">Result (%) :</label>
                            <input type="number" id="journalResultPercentage" step="any"> <!-- No longer required -->
                        </div>
                    </div>
                    <div>
                        <label for="journalComment">Comment / Emotion :</label>
                        <textarea id="journalComment" rows="3" placeholder="Notes on the trade, felt emotions..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button type="button" class="btn-secondary" id="addUpdateJournalBtn">Add to Journal</button>
                        <button type="button" class="btn-info" id="saveDraftBtn">Save Draft</button>
                    </div>
                    <button type="button" class="btn-info mt-2" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
                </form>

                <h3 class="text-gray-800 mb-4 mt-8">Filter & Sort Options</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label for="filterAssetSelect">Filter by Asset :</label>
                        <select id="filterAssetSelect" onchange="applyFiltersAndSort()">
                            <option value="">All</option>
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="XAUUSD">Gold (XAU/USD)</option>
                            <option value="DAX40">DAX 40 (Germany)</option>
                            <option value="SP500">S&P 500 (USA)</option>
                            <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                            <option value="CAC40">CAC 40 (France)</option>
                            <option value="other">Other (enter name)</option>
                        </select>
                        <input type="text" id="filterAssetCustom" placeholder="Enter asset name" style="display:none; margin-top: 0.5rem;" onkeyup="applyFiltersAndSort()">
                    </div>
                    <div>
                        <label for="filterTradeType">Filter by Trade Type :</label>
                        <select id="filterTradeType" onchange="applyFiltersAndSort()">
                            <option value="">All</option>
                            <option value="Buy">Buy</option>
                            <option value="Sell">Sell</option>
                        </select>
                    </div>
                    <div>
                        <label for="sortBy">Sort by :</label>
                        <select id="sortBy" onchange="applyFiltersAndSort()">
                            <option value="timestamp">Date</option>
                            <option value="resultEuro">Result (€)</option>
                            <option value="resultPercentage">Result (%)</option>
                            <option value="asset">Asset</option>
                        </select>
                    </div>
                    <div>
                        <label for="sortOrder">Order :</label>
                        <select id="sortOrder" onchange="applyFiltersAndSort()">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                </div>
                <button onclick="resetFiltersAndSort()" class="btn-danger mb-8">Reset Filters & Sort</button>


                <h3 class="text-gray-800 mb-4 mt-8">My Journal Entries</h3>
                <!-- Moved noEntriesMessage outside journalEntriesContainer -->
                <p class="text-center text-gray-600" id="noEntriesMessage">No journal entries yet. Add your first trade!</p>
                <div id="journalEntriesContainer" class="space-y-4">
                    <!-- Journal entries will be added here by JavaScript -->
                </div>
            </section>

            <!-- Detailed Statistics & Charts -->
            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                <h2 class="text-gray-800 mb-6">Detailed Statistics & Charts</h2>
                
                <!-- Equity Curve Chart -->
                <h3 class="text-gray-800 mb-4 mt-8">Equity Curve (Cumulative P&L)</h3>
                <div class="chart-container">
                    <canvas id="equityCurveChart"></canvas>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="detailed-stats-card">
                        <h4>Performance by Asset</h4>
                        <div id="performanceByAssetTable" class="overflow-x-auto">
                            <p class="text-center text-gray-600">No asset data available.</p>
                        </div>
                    </div>
                    <div class="detailed-stats-card">
                        <h4>Performance by Trade Type</h4>
                        <div id="performanceByTradeTypeTable" class="overflow-x-auto">
                            <p class="text-center text-gray-600">No trade type data available.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="detailed-stats-card">
                        <h4>Performance by Asset</h4>
                        <div class="chart-container">
                            <canvas id="assetPerformanceChart"></canvas>
                        </div>
                    </div>
                    <div class="detailed-stats-card">
                        <h4>Performance by Trade Type</h4>
                        <div class="chart-container">
                            <canvas id="tradeTypePerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Key for local storage
        const LOCAL_STORAGE_KEY = 'tradingJournalEntries';
        const GOAL_STORAGE_KEY = 'tradingPerformanceGoal'; // New key for goal storage

        // Array to store journal entries
        let journalEntries = [];
        // Variable to store the index of the entry being edited
        let editingEntryIndex = -1; 

        // Goal tracking variables
        let initialCapital = 10000; // Default
        let targetPnLEuro = 1000; // Default

        // Global variables for Chart.js instances
        let equityCurveChartInstance = null;
        let assetPerformanceChartInstance = null;
        let tradeTypePerformanceChartInstance = null;
        let tradingSessionsChartInstance = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Logic to show/hide custom pip value field in calculator
            const currencyPairSelect = document.getElementById('currencyPair');
            const customPipValueContainer = document.getElementById('customPipValueContainer');
            currencyPairSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customPipValueContainer.style.display = 'block';
                } else {
                    customPipValueContainer.style.display = 'none';
                }
            });

            // Logic to show/hide custom asset input in journal
            const journalAssetSelect = document.getElementById('journalAssetSelect');
            const journalAssetCustomInput = document.getElementById('journalAssetCustom');
            journalAssetSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    journalAssetCustomInput.style.display = 'block';
                    journalAssetCustomInput.setAttribute('required', 'required'); // Make required when visible
                } else {
                    journalAssetCustomInput.style.display = 'none';
                    journalAssetCustomInput.removeAttribute('required'); // Remove required when hidden
                }
            });

            // Logic to show/hide custom asset input in filter
            const filterAssetSelect = document.getElementById('filterAssetSelect');
            const filterAssetCustomInput = document.getElementById('filterAssetCustom');
            filterAssetSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    filterAssetCustomInput.style.display = 'block';
                    filterAssetCustomInput.setAttribute('required', 'required'); // Make required when visible
                } else {
                    filterAssetCustomInput.style.display = 'none';
                    filterAssetCustomInput.removeAttribute('required'); // Remove required when hidden
                }
                applyFiltersAndSort(); // Apply filters when dropdown changes
            });

            // Logic to toggle Stop Loss input method
            const stopLossInputMethodSelect = document.getElementById('stopLossInputMethod');
            const pipsDirectInputContainer = document.getElementById('pipsDirectInputContainer');
            const priceBasedInputContainer = document.getElementById('priceBasedInputContainer');

            stopLossInputMethodSelect.addEventListener('change', function() {
                if (this.value === 'pips_direct') {
                    pipsDirectInputContainer.style.display = 'block';
                    priceBasedInputContainer.style.display = 'none';
                } else {
                    pipsDirectInputContainer.style.display = 'none';
                    priceBasedInputContainer.style.display = 'block';
                }
            });

            // Handle "Add to Journal" / "Update Journal" button click
            document.getElementById('addUpdateJournalBtn').addEventListener('click', function() {
                if (editingEntryIndex === -1) {
                    addJournalEntry(false); // Not a draft
                } else {
                    updateJournalEntry(false); // Not a draft
                }
            });

            // Handle "Save Draft" button click
            document.getElementById('saveDraftBtn').addEventListener('click', function() {
                if (editingEntryIndex === -1) {
                    addJournalEntry(true); // Is a draft
                } else {
                    updateJournalEntry(true); // Is a draft
                }
            });

            // Handle Cancel Edit button
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

            // Load entries and goals from local storage on page load
            loadJournalEntries();
            loadPerformanceGoal(); // Load goal
            
            // Initial render and updates
            applyFiltersAndSort(); 
            updateTradingSessionStatus(); 
            renderTradingSessionsChart(); 
            updatePerformanceGoalDisplay(); // Update goal display on load

            // Set intervals for dynamic updates
            setInterval(() => {
                updateTradingSessionStatus();
                renderTradingSessionsChart(); // Redraw chart to update current time line
            }, 60000); // Update every minute
        });

        // Function to save entries to local storage
        function saveJournalEntries() {
            console.log("Saving entries:", journalEntries); // Save log
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(journalEntries));
        }

        // Function to load entries from local storage
        function loadJournalEntries() {
            const storedEntries = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedEntries) {
                journalEntries = JSON.parse(storedEntries);
                console.log("Entries loaded:", journalEntries); // Load log
                // Ensure timestamps are Date objects for sorting if necessary
                journalEntries.forEach(entry => {
                    if (typeof entry.timestamp === 'string') {
                        entry.timestamp = new Date(entry.timestamp);
                    }
                });
            }
        }

        // Function to save performance goal to local storage
        function savePerformanceGoal() {
            const goal = {
                initialCapital: initialCapital,
                targetPnLEuro: targetPnLEuro
            };
            localStorage.setItem(GOAL_STORAGE_KEY, JSON.stringify(goal));
            console.log("Performance goal saved:", goal);
        }

        // Function to load performance goal from local storage
        function loadPerformanceGoal() {
            const storedGoal = localStorage.getItem(GOAL_STORAGE_KEY);
            if (storedGoal) {
                const goal = JSON.parse(storedGoal);
                initialCapital = goal.initialCapital || 10000;
                targetPnLEuro = goal.targetPnLEuro || 1000;
                // Update input fields with loaded values
                document.getElementById('initialCapital').value = initialCapital;
                document.getElementById('targetPnLEuro').value = targetPnLEuro;
                console.log("Performance goal loaded:", goal);
            }
        }

        // Function to set performance goal from input fields
        function setPerformanceGoal() {
            const initialCap = parseFloat(document.getElementById('initialCapital').value);
            const targetPnL = parseFloat(document.getElementById('targetPnLEuro').value);
            const goalErrorMessageDiv = document.getElementById('goalTrackerErrorMessage');

            goalErrorMessageDiv.classList.remove('show');

            if (isNaN(initialCap) || initialCap <= 0) {
                goalErrorMessageDiv.textContent = "Please enter a valid Initial Capital (> 0).";
                goalErrorMessageDiv.classList.add('show');
                return;
            }
            if (isNaN(targetPnL) || targetPnL <= 0) {
                goalErrorMessageDiv.textContent = "Please enter a valid Target P&L (> 0).";
                goalErrorMessageDiv.classList.add('show');
                return;
            }

            initialCapital = initialCap;
            targetPnLEuro = targetPnL;
            savePerformanceGoal();
            updatePerformanceGoalDisplay();
            goalErrorMessageDiv.classList.remove('show');
        }

        // Function to update the display of the performance goal progress
        function updatePerformanceGoalDisplay() {
            // Filter out draft entries for goal calculation
            const nonDraftEntries = journalEntries.filter(entry => !entry.is_draft);
            const totalPnL = nonDraftEntries.reduce((sum, entry) => sum + entry.resultEuro, 0);
            const progressPercentage = (totalPnL / targetPnLEuro * 100).toFixed(2);
            
            const currentGoalProgressElement = document.getElementById('currentGoalProgress');
            const goalProgressBarElement = document.getElementById('goalProgressBar');
            const goalProgressDisplayBox = document.getElementById('goalProgressDisplay');

            currentGoalProgressElement.textContent = `${progressPercentage}%`;
            
            let progressBarWidth = Math.min(100, Math.max(0, progressPercentage)); // Clamp between 0 and 100
            goalProgressBarElement.style.width = `${progressBarWidth}%`;

            goalProgressBarElement.classList.remove('achieved');
            if (progressPercentage >= 100) {
                goalProgressBarElement.classList.add('achieved');
                goalProgressBarElement.textContent = 'Goal Achieved!';
            } else {
                goalProgressBarElement.textContent = ''; // Clear text if not achieved
            }

            goalProgressDisplayBox.classList.add('show'); // Ensure the display box is visible
            console.log("Performance goal display updated. Progress:", progressPercentage + "%");
        }

        // Function to get pip decimal value based on currency pair for price calculations
        function getPipDecimalValue(currencyPair) {
            switch (currencyPair) {
                case 'USDJPY': case 'EURJPY': case 'GBPJPY': 
                    return 0.01; // JPY pairs have 2 decimal places for pips
                case 'XAUUSD': 
                    return 0.01; // Gold often quoted with 2 decimal places for pips
                case 'DAX40': case 'SP500': case 'NASDAQ100': case 'CAC40': 
                    return 1; // Indices are usually 1 point = 1 pip
                case 'custom':
                    // For custom, we assume a standard Forex pip decimal value unless specified otherwise.
                    // If the user wants to calculate pips from price for a custom asset, they need to know its tick size.
                    // For simplicity, we'll use a common default for 'custom' here.
                    return 0.0001; 
                default: // Most other Forex pairs have 4 decimal places for pips
                    return 0.0001;
            }
        }

        // Function to calculate position size
        function calculatePositionSize() {
            const capital = parseFloat(document.getElementById('capital').value);
            const riskPercentage = parseFloat(document.getElementById('riskPercentage').value);
            const currencyPair = document.getElementById('currencyPair').value;
            const stopLossInputMethod = document.getElementById('stopLossInputMethod').value;
            
            let stopLossPips; // This will be calculated or taken directly
            let calcErrorMessage = null;

            if (stopLossInputMethod === 'pips_direct') {
                stopLossPips = parseFloat(document.getElementById('stopLossPips').value);
                if (isNaN(stopLossPips) || stopLossPips <= 0) {
                    calcErrorMessage = "Please enter a valid Stop Loss (in Pips) (> 0).";
                }
            } else { // price_based
                const entryPrice = parseFloat(document.getElementById('entryPrice').value);
                const stopLossPrice = parseFloat(document.getElementById('stopLossPrice').value);
                const tradeTypeForSL = document.getElementById('tradeTypeForSL').value;
                const pipDecimalValue = getPipDecimalValue(currencyPair); // Get pip decimal value based on selected currency pair

                if (isNaN(entryPrice) || isNaN(stopLossPrice) || entryPrice <= 0 || stopLossPrice <= 0) {
                    calcErrorMessage = "Please enter valid Entry Price and Stop Loss Price (> 0).";
                } else if (pipDecimalValue <= 0) {
                    calcErrorMessage = "Invalid Pip Decimal Value for the selected asset.";
                } else {
                    let priceDifference = Math.abs(entryPrice - stopLossPrice);
                    stopLossPips = priceDifference / pipDecimalValue;
                    document.getElementById('calculatedPips').textContent = stopLossPips.toFixed(2);
                    document.getElementById('calculatedPipsDisplay').style.display = 'block';
                }
            }

            const calcErrorMessageDiv = document.getElementById('calcErrorMessage');
            const resultBox = document.getElementById('resultBox');

            // Hide previous messages and results
            calcErrorMessageDiv.classList.remove('show');
            resultBox.classList.remove('show');

            // General validation
            if (isNaN(capital) || capital <= 0) {
                calcErrorMessage = calcErrorMessage || "Please enter a valid Account Capital (> 0).";
            }
            if (isNaN(riskPercentage) || riskPercentage <= 0 || riskPercentage > 100) {
                calcErrorMessage = calcErrorMessage || "Please enter a valid Risk Percentage (between 0.1 and 100).";
            }
            if (isNaN(stopLossPips) || stopLossPips <= 0) {
                 calcErrorMessage = calcErrorMessage || "Stop Loss Pips could not be determined. Please check your inputs.";
            }

            if (calcErrorMessage) {
                calcErrorMessageDiv.textContent = calcErrorMessage;
                calcErrorMessageDiv.classList.add('show');
                resultBox.style.display = 'none'; // Hide results if there's an error
                document.getElementById('calculatedPipsDisplay').style.display = 'none'; // Hide calculated pips on error
                return;
            }

            let pipValuePerStandardLot; 
            // This part uses the same currencyPair selection for the monetary value of a pip.
            switch (currencyPair) {
                case 'EURUSD': case 'GBPUSD': case 'AUDUSD': case 'NZDUSD': pipValuePerStandardLot = 10; break;
                case 'USDJPY': case 'EURJPY': case 'GBPJPY': pipValuePerStandardLot = 8.5; break; 
                case 'XAUUSD': pipValuePerStandardLot = 10; break;
                case 'DAX40': case 'SP500': case 'NASDAQ100': case 'CAC40': pipValuePerStandardLot = 1; break;
                case 'custom':
                    pipValuePerStandardLot = parseFloat(document.getElementById('customPipValue').value);
                    if (isNaN(pipValuePerStandardLot) || pipValuePerStandardLot <= 0) {
                        calcErrorMessageDiv.textContent = "Please enter a valid custom Pip/Point Value per Standard Lot (> 0).";
                        calcErrorMessageDiv.classList.add('show');
                        resultBox.style.display = 'none';
                        document.getElementById('calculatedPipsDisplay').style.display = 'none';
                        return;
                    }
                    break;
                default: pipValuePerStandardLot = 10;
            }

            const amountToRisk = (capital * riskPercentage) / 100;
            const lotSize = amountToRisk / (stopLossPips * pipValuePerStandardLot);

            document.getElementById('lotSize').textContent = lotSize.toFixed(2);
            document.getElementById('pipValueDisplay').textContent = pipValuePerStandardLot.toFixed(2);
            document.getElementById('amountRisqued').textContent = amountToRisk.toFixed(2);
            resultBox.classList.add('show');
        }

        // Function to add a journal entry
        function addJournalEntry(isDraft = false) { // Added isDraft parameter
            const journalErrorMessageDiv = document.getElementById('journalErrorMessage');
            const newEntry = getJournalFormData(isDraft); // Pass isDraft to validation

            if (!newEntry) { // If validation failed in getJournalFormData
                journalErrorMessageDiv.classList.add('show');
                return;
            }

            journalErrorMessageDiv.classList.remove('show'); // Hide error if all is good

            newEntry.timestamp = new Date().toISOString(); // Timestamp for sorting
            newEntry.is_draft = isDraft; // Set draft status
            journalEntries.unshift(newEntry); // Add new entry to the beginning of the array
            saveJournalEntries(); // Save entries after adding
            applyFiltersAndSort(); // Re-apply filters and sort to include the new entry
            updatePerformanceGoalDisplay(); // Update goal display after new trade
            document.getElementById('journalForm').reset(); // Reset the form
        }

        // Function to update an existing journal entry
        function updateJournalEntry(isDraft = false) { // Added isDraft parameter
            console.log("Starting updateJournalEntry. editingEntryIndex:", editingEntryIndex); // Update start log
            const journalErrorMessageDiv = document.getElementById('journalErrorMessage');
            const updatedEntry = getJournalFormData(isDraft); // Pass isDraft to validation

            if (!updatedEntry) { // If validation failed
                journalErrorMessageDiv.classList.add('show');
                return;
            }

            journalErrorMessageDiv.classList.remove('show');

            // Update the existing entry
            if (editingEntryIndex !== -1 && journalEntries[editingEntryIndex]) {
                journalEntries[editingEntryIndex] = {
                    ...updatedEntry,
                    timestamp: journalEntries[editingEntryIndex].timestamp, // Keep original timestamp
                    is_draft: isDraft // Update draft status
                };
                console.log("Entry updated in array:", journalEntries[editingEntryIndex]); // Updated entry log
                saveJournalEntries();
                applyFiltersAndSort(); // Re-apply filters and sort to reflect the modification
                updatePerformanceGoalDisplay(); // Update goal display after trade update
            } else {
                console.error("Error: invalid editingEntryIndex or entry not found.");
                journalErrorMessageDiv.textContent = "Error updating entry.";
                journalErrorMessageDiv.classList.add('show');
            }

            // Reset edit mode
            resetJournalForm();
        }

        // Function to get form data and validate it
        function getJournalFormData(isDraft = false) { // Added isDraft parameter
            const journalDate = document.getElementById('journalDate').value;
            const journalAssetSelect = document.getElementById('journalAssetSelect');
            const journalAssetCustomInput = document.getElementById('journalAssetCustom');
            let journalAsset;

            if (journalAssetSelect.value === 'other') {
                journalAsset = journalAssetCustomInput.value;
            } else {
                journalAsset = journalAssetSelect.value;
            }

            const journalTradeType = document.getElementById('journalTradeType').value;
            const journalSetup = document.getElementById('journalSetup').value;
            const journalEntryPrice = parseFloat(document.getElementById('journalEntryPrice').value);
            const journalSL = parseFloat(document.getElementById('journalSL').value);
            const journalTP = parseFloat(document.getElementById('journalTP').value);
            const journalRRR = document.getElementById('journalRRR').value;
            const journalPositionSize = parseFloat(document.getElementById('journalPositionSize').value);
            const journalResultEuro = parseFloat(document.getElementById('journalResultEuro').value);
            const journalResultPercentage = parseFloat(document.getElementById('journalResultPercentage').value);
            const journalComment = document.getElementById('journalComment').value;
            const journalErrorMessageDiv = document.getElementById('journalErrorMessage');

            // Validation of required fields
            // If it's a draft, result fields are not required
            if (!journalDate || !journalAsset || isNaN(journalEntryPrice) || isNaN(journalSL) || isNaN(journalTP) || isNaN(journalPositionSize) || (!isDraft && (isNaN(journalResultEuro) || isNaN(journalResultPercentage)))) {
                journalErrorMessageDiv.textContent = "Please fill in all required journal fields (Date, Asset, Entry, SL, TP, Position Size). Results are optional for drafts.";
                console.log("Validation failed: missing or invalid fields."); // Validation log
                return null;
            }
            console.log("Form data retrieved and validated:", { journalDate, journalAsset, journalEntryPrice, journalResultEuro, isDraft }); // Validated data log
            return {
                date: journalDate,
                asset: journalAsset,
                tradeType: journalTradeType,
                setup: journalSetup,
                entryPrice: journalEntryPrice,
                stopLoss: journalSL,
                takeProfit: journalTP,
                rrr: journalRRR,
                positionSize: journalPositionSize,
                // Ensure result fields are stored as null/0 if not provided in draft
                resultEuro: isDraft && isNaN(journalResultEuro) ? 0 : journalResultEuro,
                resultPercentage: isDraft && isNaN(journalResultPercentage) ? 0 : journalResultPercentage,
                comment: journalComment
            };
        }

        // Function to load entry data into the form for editing
        function editJournalEntry(index) {
            const entry = journalEntries[index];
            console.log("Starting editJournalEntry. Index:", index, "Entry:", entry); // Edit log
            document.getElementById('journalDate').value = entry.date;
            
            const journalAssetSelect = document.getElementById('journalAssetSelect');
            const journalAssetCustomInput = document.getElementById('journalAssetCustom');
            const assetOptions = Array.from(journalAssetSelect.options).map(option => option.value);

            if (assetOptions.includes(entry.asset)) {
                journalAssetSelect.value = entry.asset;
                journalAssetCustomInput.style.display = 'none';
                journalAssetCustomInput.removeAttribute('required');
            } else {
                journalAssetSelect.value = 'other';
                journalAssetCustomInput.value = entry.asset;
                journalAssetCustomInput.style.display = 'block';
                journalAssetCustomInput.setAttribute('required', 'required');
            }

            document.getElementById('journalTradeType').value = entry.tradeType;
            document.getElementById('journalSetup').value = entry.setup;
            document.getElementById('journalEntryPrice').value = entry.entryPrice;
            document.getElementById('journalSL').value = entry.stopLoss;
            document.getElementById('journalTP').value = entry.takeProfit;
            document.getElementById('journalRRR').value = entry.rrr;
            document.getElementById('journalPositionSize').value = entry.positionSize;
            // Handle potentially empty result fields for drafts
            document.getElementById('journalResultEuro').value = entry.resultEuro || ''; 
            document.getElementById('journalResultPercentage').value = entry.resultPercentage || '';
            document.getElementById('journalComment').value = entry.comment;

            editingEntryIndex = index; // Set the index of the entry being edited
            document.getElementById('addUpdateJournalBtn').textContent = 'Update Journal';
            document.getElementById('addUpdateJournalBtn').classList.remove('btn-secondary');
            document.getElementById('addUpdateJournalBtn').classList.add('btn-info'); // Change color to indicate modification
            document.getElementById('saveDraftBtn').style.display = 'block'; // Show Save Draft when editing
            document.getElementById('cancelEditBtn').style.display = 'block'; // Show Cancel button
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of page
        }

        // Function to cancel editing and reset the form
        function cancelEdit() {
            console.log("Cancelling edit."); // Cancel log
            resetJournalForm();
        }

        // Function to reset the journal form and edit mode
        function resetJournalForm() {
            document.getElementById('journalForm').reset();
            document.getElementById('journalAssetCustom').style.display = 'none'; // Hide custom asset input
            document.getElementById('journalAssetCustom').removeAttribute('required'); // Remove required attribute
            editingEntryIndex = -1;
            document.getElementById('addUpdateJournalBtn').textContent = 'Add to Journal';
            document.getElementById('addUpdateJournalBtn').classList.remove('btn-info');
            document.getElementById('addUpdateJournalBtn').classList.add('btn-secondary');
            document.getElementById('saveDraftBtn').style.display = 'block'; // Show Save Draft again
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('journalErrorMessage').classList.remove('show');
            console.log("Form reset. editingEntryIndex:", editingEntryIndex); // Reset log
        }

        // Function to delete a journal entry
        function deleteJournalEntry(index) {
            // Use a custom confirmation modal instead of confirm()
            showCustomConfirm('Are you sure you want to delete this journal entry?', () => {
                console.log("Deleting entry at index:", index); // Delete log
                journalEntries.splice(index, 1); // Remove entry from array
                saveJournalEntries(); // Save changes
                applyFiltersAndSort(); // Re-apply filters and sort after deletion
                updatePerformanceGoalDisplay(); // Update goal display after trade deletion
                resetJournalForm(); // Reset form in case the deleted entry was being edited
            });
        }

        // Function to apply filters and sort, then render the journal
        function applyFiltersAndSort() {
            let filteredEntries = [...journalEntries]; // Copy to avoid modifying the original

            // 1. Filtering
            const filterAssetSelect = document.getElementById('filterAssetSelect');
            const filterAssetCustomInput = document.getElementById('filterAssetCustom');
            let filterAssetValue = '';
            if (filterAssetSelect.value === 'other') {
                filterAssetValue = filterAssetCustomInput.value.toLowerCase();
            } else {
                filterAssetValue = filterAssetSelect.value.toLowerCase();
            }

            const filterTradeType = document.getElementById('filterTradeType').value;

            if (filterAssetValue) { // Use the determined filterAssetValue
                filteredEntries = filteredEntries.filter(entry => 
                    entry.asset.toLowerCase().includes(filterAssetValue)
                );
            }
            if (filterTradeType) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.tradeType === filterTradeType
                );
            }

            // 2. Sorting
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            filteredEntries.sort((a, b) => {
                let valA, valB;

                if (sortBy === 'timestamp') {
                    valA = new Date(a.timestamp).getTime();
                    valB = new Date(b.timestamp).getTime();
                } else if (sortBy === 'resultEuro' || sortBy === 'resultPercentage') {
                    valA = a[sortBy];
                    valB = b[sortBy];
                } else { // 'asset'
                    valA = a[sortBy].toLowerCase();
                    valB = b[sortBy].toLowerCase();
                }

                if (sortOrder === 'asc') {
                    if (valA < valB) return -1;
                    if (valA > valB) return 1;
                } else { // 'desc'
                    if (valA > valB) return -1;
                    if (valA < valB) return 1;
                }
                return 0;
            });

            renderFilteredJournalEntries(filteredEntries); // Render filtered and sorted entries
            updatePerformanceMetrics(filteredEntries); // Update metrics based on filtered entries
            updateDetailedPerformanceMetrics(filteredEntries); // Update detailed statistics and charts
        }

        // Function to reset filters and sort
        function resetFiltersAndSort() {
            document.getElementById('filterAssetSelect').value = ''; // Reset dropdown
            document.getElementById('filterAssetCustom').value = ''; // Clear custom input
            document.getElementById('filterAssetCustom').style.display = 'none'; // Hide custom input
            document.getElementById('filterAssetCustom').removeAttribute('required'); // Remove required
            document.getElementById('filterTradeType').value = '';
            document.getElementById('sortBy').value = 'timestamp';
            document.getElementById('sortOrder').value = 'desc';
            applyFiltersAndSort(); // Apply default settings
        }

        // Function to display journal entries (filtered/sorted)
        function renderFilteredJournalEntries(entriesToRender) {
            console.log("Rendering filtered/sorted journal entries. Number of entries:", entriesToRender.length);
            const journalEntriesContainer = document.getElementById('journalEntriesContainer');
            const noEntriesMessage = document.getElementById('noEntriesMessage'); 

            journalEntriesContainer.innerHTML = ''; // Clear container

            if (entriesToRender.length > 0) {
                noEntriesMessage.style.display = 'none';
            } else {
                noEntriesMessage.style.display = 'block';
            }
            
            entriesToRender.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                
                const resultClass = entry.resultEuro >= 0 ? 'result-positive' : 'result-negative';
                const draftIndicator = entry.is_draft ? '<span class="text-yellow-500 font-bold ml-2">(Draft)</span>' : ''; // Indicator for drafts

                entryDiv.innerHTML = `
                    <p><span class="label">Date:</span> <span class="value">${entry.date}</span></p>
                    <p><span class="label">Asset:</span> <span class="value">${entry.asset}</span> - <span class="value">${entry.tradeType}</span>${draftIndicator}</p>
                    <p><span class="label">Setup:</span> <span class="value">${entry.setup || 'N/A'}</span></p>
                    <p><span class="label">Entry:</span> <span class="value">${entry.entryPrice}</span> | <span class="label">SL:</span> <span class="value">${entry.stopLoss}</span> | <span class="label">TP:</span> <span class="value">${entry.takeProfit}</span> | <span class="label">RRR:</span> <span class="value">${entry.rrr || 'N/A'}</span></p>
                    <p><span class="label">Position Size:</span> <span class="value">${entry.positionSize} lots</span></p>
                    <p class="text-lg font-bold ${resultClass}">Result: ${entry.resultEuro} € (${entry.resultPercentage}%)</p>
                    <p><span class="label">Comment:</span> <span class="value">${entry.comment || 'None'}</span></p>
                    <div class="journal-actions">
                        <button onclick="editJournalEntry(${journalEntries.indexOf(entry)})" class="btn-info">Edit</button>
                        <button onclick="deleteJournalEntry(${journalEntries.indexOf(entry)})" class="btn-danger">Delete</button>
                    </div>
                `;
                journalEntriesContainer.appendChild(entryDiv);
            });
        }

        // Function to update global performance statistics
        function updatePerformanceMetrics(entriesToCalculate) { // Takes entries to calculate (filtered or all)
            console.log("Updating global performance statistics...");
            // Filter out draft entries for global stats calculation
            const nonDraftEntries = entriesToCalculate.filter(entry => !entry.is_draft);

            const totalTrades = nonDraftEntries.length;
            let winningTrades = 0;
            let losingTrades = 0;
            let totalPnL = 0;
            let totalPnLPercentage = 0;
            let largestWin = 0;
            let largestLoss = 0; 

            nonDraftEntries.forEach(entry => {
                const resultEuro = entry.resultEuro;
                const resultPercentage = entry.resultPercentage;

                if (resultEuro > 0) {
                    winningTrades++;
                    if (resultEuro > largestWin) {
                        largestWin = resultEuro;
                    }
                } else if (resultEuro < 0) {
                    losingTrades++;
                    if (resultEuro < largestLoss) { 
                        largestLoss = resultEuro;
                    }
                }
                totalPnL += resultEuro;
                totalPnLPercentage += resultPercentage;
            });

            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(2) : '0.00';
            const avgPnL = totalTrades > 0 ? (totalPnL / totalTrades).toFixed(2) : '0.00';

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winningTrades').textContent = winningTrades;
            document.getElementById('losingTrades').textContent = losingTrades;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('totalPnL').textContent = `${totalPnL.toFixed(2)} €`;
            document.getElementById('totalPnLPercentage').textContent = `${totalPnLPercentage.toFixed(2)}%`;
            document.getElementById('avgPnL').textContent = `${avgPnL} €`;
            document.getElementById('largestWin').textContent = `${largestWin.toFixed(2)} €`;
            document.getElementById('largestLoss').textContent = `${largestLoss.toFixed(2)} €`;

            // Update P&L metric colors based on result
            const totalPnLMetric = document.getElementById('totalPnLMetric');
            const totalPnLPercentageMetric = document.getElementById('totalPnLPercentageMetric');
            const avgPnLMetric = document.getElementById('avgPnLMetric');

            totalPnLMetric.classList.toggle('positive', totalPnL > 0);
            totalPnLMetric.classList.toggle('negative', totalPnL < 0);
            totalPnLPercentageMetric.classList.toggle('positive', totalPnLPercentage > 0);
            totalPnLPercentageMetric.classList.toggle('negative', totalPnLPercentage < 0);
            avgPnLMetric.classList.toggle('positive', parseFloat(avgPnL) > 0);
            avgPnLMetric.classList.toggle('negative', parseFloat(avgPnL) < 0);

            console.log("Global performance statistics updated.");
        }

        // Function to update detailed performance statistics and charts
        function updateDetailedPerformanceMetrics(entriesToCalculate) {
            console.log("Updating detailed performance statistics and charts...");
            // Filter out draft entries for detailed stats calculation
            const nonDraftEntries = entriesToCalculate.filter(entry => !entry.is_draft);

            const performanceByAsset = {};
            const performanceByTradeType = {};

            nonDraftEntries.forEach(entry => {
                // By Asset
                const asset = entry.asset.toUpperCase();
                if (!performanceByAsset[asset]) {
                    performanceByAsset[asset] = { totalTrades: 0, winningTrades: 0, totalPnL: 0, totalPnLPercentage: 0 };
                }
                performanceByAsset[asset].totalTrades++;
                if (entry.resultEuro > 0) {
                    performanceByAsset[asset].winningTrades++;
                }
                performanceByAsset[asset].totalPnL += entry.resultEuro;
                performanceByAsset[asset].totalPnLPercentage += entry.resultPercentage;

                // By Trade Type
                const tradeType = entry.tradeType;
                if (!performanceByTradeType[tradeType]) {
                    performanceByTradeType[tradeType] = { totalTrades: 0, winningTrades: 0, totalPnL: 0, totalPnLPercentage: 0 };
                }
                performanceByTradeType[tradeType].totalTrades++;
                if (entry.resultEuro > 0) {
                    performanceByTradeType[tradeType].winningTrades++;
                }
                performanceByTradeType[tradeType].totalPnL += entry.resultEuro;
                performanceByTradeType[tradeType].totalPnLPercentage += entry.resultPercentage;
            });

            // Render performance by asset (table)
            const assetContainer = document.getElementById('performanceByAssetTable');
            assetContainer.innerHTML = '';
            if (Object.keys(performanceByAsset).length === 0) {
                assetContainer.innerHTML = '<p class="text-center text-gray-600">No asset data available.</p>';
            } else {
                let assetTableHTML = `
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Trades</th>
                                <th>P&L (€)</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                for (const asset in performanceByAsset) {
                    const stats = performanceByAsset[asset];
                    const winRate = stats.totalTrades > 0 ? (stats.winningTrades / stats.totalTrades * 100).toFixed(2) : '0.00';
                    const pnLClass = stats.totalPnL >= 0 ? 'positive-text' : 'negative-text';
                    assetTableHTML += `
                        <tr>
                            <td>${asset}</td>
                            <td>${stats.totalTrades}</td>
                            <td class="${pnLClass}">${stats.totalPnL.toFixed(2)} €</td>
                            <td>${winRate}%</td>
                        </tr>
                    `;
                }
                assetTableHTML += `
                        </tbody>
                    </table>
                `;
                assetContainer.innerHTML = assetTableHTML;
            }

            // Render performance by trade type (table)
            const tradeTypeContainer = document.getElementById('performanceByTradeTypeTable');
            tradeTypeContainer.innerHTML = '';
            if (Object.keys(performanceByTradeType).length === 0) {
                tradeTypeContainer.innerHTML = '<p class="text-center text-gray-600">No trade type data available.</p>';
            } else {
                let tradeTypeTableHTML = `
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Trades</th>
                                <th>P&L (€)</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                for (const type in performanceByTradeType) {
                    const stats = performanceByTradeType[type];
                    const winRate = stats.totalTrades > 0 ? (stats.winningTrades / stats.totalTrades * 100).toFixed(2) : '0.00';
                    const pnLClass = stats.totalPnL >= 0 ? 'positive-text' : 'negative-text';
                    tradeTypeTableHTML += `
                        <tr>
                            <td>${type}</td>
                            <td>${stats.totalTrades}</td>
                            <td class="${pnLClass}">${stats.totalPnL.toFixed(2)} €</td>
                            <td>${winRate}%</td>
                        </tr>
                    `;
                }
                tradeTypeTableHTML += `
                        </tbody>
                    </table>
                `;
                tradeTypeContainer.innerHTML = tradeTypeTableHTML;
            }
            console.log("Detailed statistics updated.");

            // Render charts
            renderEquityCurveChart(nonDraftEntries); // Pass non-draft entries for charts
            renderAssetPerformanceChart(performanceByAsset);
            renderTradeTypePerformanceChart(performanceByTradeType);
        }

        // Function to render the equity curve chart
        function renderEquityCurveChart(entries) {
            const ctx = document.getElementById('equityCurveChart').getContext('2d');

            // Sort entries by date for the equity curve
            const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = [];
            const cumulativePnL = [];
            let currentPnL = 0;

            sortedEntries.forEach(entry => {
                labels.push(entry.date);
                currentPnL += entry.resultEuro;
                cumulativePnL.push(currentPnL);
            });

            // Destroy old chart instance if it exists
            if (equityCurveChartInstance) {
                equityCurveChartInstance.destroy();
            }

            equityCurveChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative P&L (€)',
                        data: cumulativePnL,
                        borderColor: '#7f58af', /*  purple */
                        backgroundColor: 'rgba(127, 88, 175, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false, // Title already in H3
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'P&L (€)'
                            }
                        }
                    }
                }
            });
        }

        // Function to render asset performance chart
        function renderAssetPerformanceChart(data) {
            const ctx = document.getElementById('assetPerformanceChart').getContext('2d');

            const labels = Object.keys(data);
            const pnLValues = labels.map(label => data[label].totalPnL);

            const backgroundColors = pnLValues.map(value => value >= 0 ? '#48bb78' : '#f56565'); // Green for gain, red for loss 

            // Destroy old chart instance if it exists
            if (assetPerformanceChartInstance) {
                assetPerformanceChartInstance.destroy();
            }

            assetPerformanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total P&L (€)',
                        data: pnLValues,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false,
                        },
                        legend: {
                            display: false, // No legend needed for a single series with conditional colors
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Asset'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'P&L (€)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Function to render trade type performance chart
        function renderTradeTypePerformanceChart(data) {
            const ctx = document.getElementById('tradeTypePerformanceChart').getContext('2d');

            const labels = Object.keys(data);
            const pnLValues = labels.map(label => data[label].totalPnL);

            const backgroundColors = [
                '#7f58af', /*  purple for Buy */
                '#f6ad55', /*  orange for Sell */
                '#a0aec0' /* Gray for other (if applicable) */
            ]; 

            // Destroy old chart instance if it exists
            if (tradeTypePerformanceChartInstance) {
                tradeTypePerformanceChartInstance.destroy();
            }

            tradeTypePerformanceChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total P&L (€)',
                        data: pnLValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false,
                        },
                        legend: {
                            display: true,
                            position: 'right',
                        }
                    }
                }
            });
        }

        // --- Trading Session Status Logic ---
        function updateTradingSessionStatus() {
            const now = new Date(); // Current local time
            const utcHour = now.getUTCHours();
            const utcMinute = now.getUTCMinutes();

            // Define major trading sessions in UTC hours
            // London: 08:00 - 16:00 UTC
            // New York: 13:00 - 21:00 UTC
            // Tokyo: 00:00 - 09:00 UTC (overlaps with Sydney)
            // Sydney: 22:00 (previous day) - 07:00 UTC

            const sessions = {
                london: { start: 8, end: 16, elementId: 'londonStatus' },
                newYork: { start: 13, end: 21, elementId: 'newYorkStatus' },
                tokyo: { start: 0, end: 9, elementId: 'tokyoStatus' },
                sydney: { start: 22, end: 7, elementId: 'sydneyStatus' } // Sydney spans across midnight UTC
            };

            for (const sessionName in sessions) {
                const session = sessions[sessionName];
                const statusElement = document.getElementById(session.elementId);
                const parentSessionItem = statusElement ? statusElement.closest('.session-item') : null;
                let isOpen = false;

                if (session.start < session.end) { // Session does not cross midnight UTC
                    isOpen = (utcHour >= session.start && utcHour < session.end);
                } else { // Session crosses midnight UTC (e.g., Sydney)
                    isOpen = (utcHour >= session.start || utcHour < session.end);
                }

                if (parentSessionItem) {
                    parentSessionItem.classList.remove('open', 'closed');
                    parentSessionItem.classList.add(isOpen ? 'open' : 'closed');
                }
            }
        }

        // --- Session Overlap Chart Drawing Logic (using Chart.js) ---
        // Chart.js plugin to draw a vertical line for current UTC time
        const currentTimeLinePlugin = {
            id: 'currentTimeLine',
            beforeDraw(chart, args, options) {
                const { ctx, chartArea: { left, right, top, bottom }, scales: { x } } = chart;
                const now = new Date();
                const currentUTCHour = now.getUTCHours();
                const currentUTCMinute = now.getUTCMinutes();
                const currentTimeInHours = currentUTCHour + currentUTCMinute / 60;

                // Calculate X position of the current time line
                const pixelX = x.getPixelForValue(currentTimeInHours);

                ctx.save();
                ctx.beginPath();
                ctx.strokeStyle = options.lineColor || '#ef4444'; // Red line
                ctx.lineWidth = options.lineWidth || 2;
                ctx.moveTo(pixelX, top);
                ctx.lineTo(pixelX, bottom);
                ctx.stroke();

                ctx.fillStyle = options.labelColor || '#ef4444';
                ctx.font = options.labelFont || '12px Inter';
                ctx.textAlign = 'left';
                ctx.fillText(`Current: ${currentUTCHour.toString().padStart(2, '0')}:${currentUTCMinute.toString().padStart(2, '0')} UTC`, pixelX + 5, top + 15);
                ctx.restore();
            }
        };

        function renderTradingSessionsChart() {
            const ctx = document.getElementById('tradingSessionsChartCanvas').getContext('2d');

            // Session data for Chart.js horizontal bar chart
            const sessionsData = [
                { name: 'London', start: 8, end: 16, color: 'rgba(127, 88, 175, 0.6)' }, /*  purple */
                { name: 'New York', start: 13, end: 21, color: 'rgba(246, 173, 85, 0.6)' }, /*  orange */
                { name: 'Tokyo', start: 0, end: 9, color: 'rgba(66, 153, 225, 0.6)' }, /*  blue */
                { name: 'Sydney', start: 22, end: 7, color: 'rgba(76, 175, 80, 0.6)' } /*  green */
            ];

            const datasets = [];
            const labels = [];

            sessionsData.forEach(session => {
                labels.push(session.name);
                // For sessions crossing midnight, create two segments
                if (session.start > session.end) {
                    datasets.push({
                        label: session.name,
                        backgroundColor: session.color,
                        borderColor: session.color.replace('0.6', '1'),
                        borderWidth: 1,
                        data: [{ x: [session.start, 24], y: session.name }]
                    });
                    datasets.push({
                        label: session.name,
                        backgroundColor: session.color,
                        borderColor: session.color.replace('0.6', '1'),
                        borderWidth: 1,
                        data: [{ x: [0, session.end], y: session.name }]
                    });
                } else {
                    datasets.push({
                        label: session.name,
                        backgroundColor: session.color,
                        borderColor: session.color.replace('0.6', '1'),
                        borderWidth: 1,
                        data: [{ x: [session.start, session.end], y: session.name }]
                    });
                }
            });

            // Destroy old chart instance if it exists
            if (tradingSessionsChartInstance) {
                tradingSessionsChartInstance.destroy();
            }

            tradingSessionsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels, // Use session names as Y-axis labels
                    datasets: datasets
                },
                options: {
                    indexAxis: 'y', // Make it a horizontal bar chart
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false,
                        },
                        legend: {
                            display: false, // Hide dataset legends, labels are on Y-axis
                        },
                        currentTimeLine: { // Plugin options
                            lineColor: '#ef4444', /*  red */
                            lineWidth: 2,
                            labelColor: '#ef4444',
                            labelFont: '12px Inter'
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            min: 0,
                            max: 24,
                            ticks: {
                                stepSize: 3, // Show ticks every 3 hours
                                callback: function(value) {
                                    return value + 'h'; // Add 'h' suffix
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time (UTC)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Session'
                            }
                        }
                    }
                },
                plugins: [currentTimeLinePlugin] // Register the plugin
            });
        }


        // --- Custom confirmation modal (replaces alert/confirm) ---
        function showCustomConfirm(message, onConfirm) {
            const modalId = 'customConfirmModal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg font-semibold text-gray-800 mb-4" id="customConfirmMessage"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancel</button>
                            <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirm</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('customConfirmMessage').textContent = message;
            modal.style.display = 'flex'; // Show modal

            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');

            // Clean up old event listeners to prevent multiple calls
            const newConfirmOkBtn = confirmOkBtn.cloneNode(true);
            confirmOkBtn.parentNode.replaceChild(newConfirmOkBtn, confirmOkBtn);
            const newConfirmCancelBtn = confirmCancelBtn.cloneNode(true);
            confirmCancelBtn.parentNode.replaceChild(newConfirmCancelBtn, confirmCancelBtn);

            newConfirmOkBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                if (onConfirm) {
                    onConfirm();
                }
            });

            newConfirmCancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        // --- End of custom confirmation modal ---
    </script>
</body>
</html>
