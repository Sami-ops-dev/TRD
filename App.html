<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Trading App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Inter font for better readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for scrolling */
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px; /* Max width for larger screens */
            border: 1px solid #e2e8f0;
        }
        h1 {
            color: #2d3748;
            font-size: 2.25rem; /* Larger title font size */
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        h2 {
            color: #2d3748;
            font-size: 1.875rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        h3 {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 600;
        }
        input[type="number"], input[type="text"], input[type="date"], select, textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1.25rem;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }
        button {
            width: 100%;
            padding: 0.875rem 1.25rem;
            color: white;
            font-weight: 700;
            border-radius: 0.75rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #6366f1; /* Violet blue */
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        .btn-secondary {
            background-color: #22c55e; /* Green */
        }
        .btn-secondary:hover {
            background-color: #16a34a;
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-info {
            background-color: #3b82f6; /* Blue */
        }
        .btn-info:hover {
            background-color: #2563eb;
        }
        .result-box {
            background-color: #e0f2fe;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            border: 1px solid #90cdf4;
            color: #2c5282;
            font-weight: 600;
            text-align: center;
            display: none;
        }
        .result-box.show {
            display: block;
        }
        .error-message {
            color: #e53e3e;
            background-color: #fed7d7;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1.25rem;
            text-align: center;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        .journal-entry {
            background-color: #f8fafc; /* Very light blue-gray */
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            position: relative; /* For positioning buttons */
        }
        .journal-entry p {
            margin-bottom: 0.25rem;
        }
        .journal-entry .label {
            font-weight: 600;
            color: #4a5568;
        }
        .journal-entry .value {
            color: #2d3748;
        }
        .journal-entry .result-positive {
            color: #10b981; /* Emerald green */
            font-weight: 700;
        }
        .journal-entry .result-negative {
            color: #ef4444; /* Red */
            font-weight: 700;
        }
        .journal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            justify-content: flex-end; /* Align buttons to the right */
        }
        .journal-actions button {
            width: auto; /* Buttons don't take full width */
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
            box-shadow: none; /* No extra shadow for small buttons */
        }
        .journal-actions button:hover {
            transform: none; /* No lift effect for small buttons */
        }
        .journal-actions button:active {
            transform: none;
        }
        /* Styles for performance dashboard */
        .performance-metric {
            background-color: #e0f2fe; /* Light blue */
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .performance-metric p {
            margin-bottom: 0.25rem;
            color: #4a5568;
        }
        .performance-metric .value {
            font-size: 1.75rem; /* Larger font size */
            font-weight: 700;
            color: #1d4ed8; /* Dark blue */
        }
        .performance-metric.positive .value {
            color: #10b981; /* Green for gains */
        }
        .performance-metric.negative .value {
            color: #ef4444; /* Red for losses */
        }
        .detailed-stats-card {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 1rem;
        }
        .detailed-stats-card h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        .detailed-stats-card table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }
        .detailed-stats-card th, .detailed-stats-card td {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            text-align: left;
        }
        .detailed-stats-card th {
            background-color: #edf2f7;
            font-weight: 600;
            color: #4a5568;
        }
        .detailed-stats-card td {
            color: #2d3748;
        }
        .detailed-stats-card tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .detailed-stats-card .positive-text {
            color: #10b981;
            font-weight: 600;
        }
        .detailed-stats-card .negative-text {
            color: #ef4444;
            font-weight: 600;
        }
        /* Specific styles for chart containers */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for charts */
            width: 100%;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="text-center mb-8">
            <h1 class="text-indigo-700 mb-2">My Trading App</h1>
            <p class="text-gray-600">Manage your risk and track your performance.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Global Performance Statistics Dashboard -->
            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                <h2 class="text-gray-800 mb-6">Global Performance Statistics</h2>
                <div id="performanceDashboard" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-center">
                    <div class="performance-metric">
                        <p>Total Trades</p>
                        <p id="totalTrades" class="value">0</p>
                    </div>
                    <div class="performance-metric positive">
                        <p>Winning Trades</p>
                        <p id="winningTrades" class="value">0</p>
                    </div>
                    <div class="performance-metric negative">
                        <p>Losing Trades</p>
                        <p id="losingTrades" class="value">0</p>
                    </div>
                    <div class="performance-metric">
                        <p>Win Rate</p>
                        <p id="winRate" class="value">0.00%</p>
                    </div>
                    <div class="performance-metric" id="totalPnLMetric">
                        <p>Total P&L (€)</p>
                        <p id="totalPnL" class="value">0.00 €</p>
                    </div>
                    <div class="performance-metric" id="totalPnLPercentageMetric">
                        <p>Total P&L (%)</p>
                        <p id="totalPnLPercentage" class="value">0.00%</p>
                    </div>
                    <div class="performance-metric" id="avgPnLMetric">
                        <p>Avg P&L per Trade (€)</p>
                        <p id="avgPnL" class="value">0.00 €</p>
                    </div>
                    <div class="performance-metric positive">
                        <p>Largest Win (€)</p>
                        <p id="largestWin" class="value">0.00 €</p>
                    </div>
                    <div class="performance-metric negative">
                        <p>Largest Loss (€)</p>
                        <p id="largestLoss" class="value">0.00 €</p>
                    </div>
                </div>
            </section>

            <!-- Position Size Calculator -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-gray-800 mb-6">Position Size Calculator</h2>
                <div id="calcErrorMessage" class="error-message"></div>
                <div class="space-y-4">
                    <div>
                        <label for="capital">Account Capital (€) :</label>
                        <input type="number" id="capital" value="10000" min="1" step="any">
                    </div>
                    <div>
                        <label for="riskPercentage">Risk Percentage per Trade (%) :</label>
                        <input type="number" id="riskPercentage" value="1" min="0.1" max="10" step="0.1">
                    </div>
                    <div>
                        <label for="stopLossPips">Stop Loss (in Pips) :</label>
                        <input type="number" id="stopLossPips" value="20" min="1" step="any">
                    </div>
                    <div>
                        <label for="currencyPair">Currency Pair / Asset :</label>
                        <select id="currencyPair">
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="XAUUSD">Gold (XAU/USD)</option>
                            <option value="DAX40">DAX 40 (Germany)</option>
                            <option value="SP500">S&P 500 (USA)</option>
                            <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                            <option value="CAC40">CAC 40 (France)</option>
                            <option value="custom">Other (enter pip value)</option>
                        </select>
                    </div>
                    <div id="customPipValueContainer" style="display: none;">
                        <label for="customPipValue">Pip/Point Value per Standard Lot (€) :</label>
                        <input type="number" id="customPipValue" value="10" min="0.01" step="any">
                    </div>
                    <button onclick="calculatePositionSize()" class="btn-primary">Calculate Position Size</button>
                    <div id="resultBox" class="result-box">
                        <p>Recommended Position Size : <span id="lotSize"></span> lots</p>
                        <p>Pip/Point Value : <span id="pipValueDisplay"></span> €</p>
                        <p>Amount Risked : <span id="amountRisqued"></span> €</p>
                    </div>
                </div>
            </section>

            <!-- Trading Journal -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-gray-800 mb-6">Trading Journal</h2>
                <div id="journalErrorMessage" class="error-message"></div>
                <form id="journalForm" class="space-y-4 mb-8">
                    <div>
                        <label for="journalDate">Date :</label>
                        <input type="date" id="journalDate" required>
                    </div>
                    <div>
                        <label for="journalAsset">Asset :</label>
                        <select id="journalAssetSelect">
                            <option value="EURUSD">EUR/USD</option>
                            <option value="GBPUSD">GBP/USD</option>
                            <option value="USDJPY">USD/JPY</option>
                            <option value="AUDUSD">AUD/USD</option>
                            <option value="USDCAD">USD/CAD</option>
                            <option value="USDCHF">USD/CHF</option>
                            <option value="NZDUSD">NZD/USD</option>
                            <option value="EURJPY">EUR/JPY</option>
                            <option value="GBPJPY">GBP/JPY</option>
                            <option value="XAUUSD">Gold (XAU/USD)</option>
                            <option value="DAX40">DAX 40 (Germany)</option>
                            <option value="SP500">S&P 500 (USA)</option>
                            <option value="NASDAQ100">NASDAQ 100 (USA)</option>
                            <option value="CAC40">CAC 40 (France)</option>
                            <option value="other">Other (enter name)</option>
                        </select>
                        <input type="text" id="journalAssetCustom" placeholder="Enter asset name" style="display:none; margin-top: 0.5rem;">
                    </div>
                    <div>
                        <label for="journalTradeType">Trade Type :</label>
                        <select id="journalTradeType">
                            <option value="Buy">Buy (Long)</option>
                            <option value="Sell">Sell (Short)</option>
                        </select>
                    </div>
                    <div>
                        <label for="journalSetup">Setup :</label>
                        <input type="text" id="journalSetup" placeholder="Ex: Resistance breakout, MA rejection">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="journalEntryPrice">Entry :</label>
                            <input type="number" id="journalEntryPrice" step="any" required>
                        </div>
                        <div>
                            <label for="journalSL">SL :</label>
                            <input type="number" id="journalSL" step="any" required>
                        </div>
                        <div>
                            <label for="journalTP">TP :</label>
                            <input type="number" id="journalTP" step="any" required>
                        </div>
                    </div>
                    <div>
                        <label for="journalRRR">RRR (Ex: 1:2) :</label>
                        <input type="text" id="journalRRR" placeholder="Ex: 1:2">
                    </div>
                    <div>
                        <label for="journalPositionSize">Position Size :</label>
                        <input type="number" id="journalPositionSize" step="any" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="journalResultEuro">Result (€) :</label>
                            <input type="number" id="journalResultEuro" step="any" required>
                        </div>
                        <div>
                            <label for="journalResultPercentage">Result (%) :</label>
                            <input type="number" id="journalResultPercentage" step="any" required>
                        </div>
                    </div>
                    <div>
                        <label for="journalComment">Comment / Emotion :</label>
                        <textarea id="journalComment" rows="3" placeholder="Notes on the trade, felt emotions..."></textarea>
                    </div>
                    <button type="submit" class="btn-secondary" id="addUpdateJournalBtn">Add to Journal</button>
                    <button type="button" class="btn-info" id="cancelEditBtn" style="display:none;">Cancel Edit</button>
                </form>

                <h3 class="text-gray-800 mb-4 mt-8">Filter & Sort Options</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div>
                        <label for="filterAsset">Filter by Asset :</label>
                        <input type="text" id="filterAsset" placeholder="Ex: EUR/USD" onkeyup="applyFiltersAndSort()">
                    </div>
                    <div>
                        <label for="filterTradeType">Filter by Trade Type :</label>
                        <select id="filterTradeType" onchange="applyFiltersAndSort()">
                            <option value="">All</option>
                            <option value="Buy">Buy</option>
                            <option value="Sell">Sell</option>
                        </select>
                    </div>
                    <div>
                        <label for="sortBy">Sort by :</label>
                        <select id="sortBy" onchange="applyFiltersAndSort()">
                            <option value="timestamp">Date</option>
                            <option value="resultEuro">Result (€)</option>
                            <option value="resultPercentage">Result (%)</option>
                            <option value="asset">Asset</option>
                        </select>
                    </div>
                    <div>
                        <label for="sortOrder">Order :</label>
                        <select id="sortOrder" onchange="applyFiltersAndSort()">
                            <option value="desc">Descending</option>
                            <option value="asc">Ascending</option>
                        </select>
                    </div>
                </div>
                <button onclick="resetFiltersAndSort()" class="btn-danger mb-8">Reset Filters & Sort</button>


                <h3 class="text-gray-800 mb-4 mt-8">My Journal Entries</h3>
                <!-- Moved noEntriesMessage outside journalEntriesContainer -->
                <p class="text-center text-gray-600" id="noEntriesMessage">No journal entries yet. Add your first trade!</p>
                <div id="journalEntriesContainer" class="space-y-4">
                    <!-- Journal entries will be added here by JavaScript -->
                </div>
            </section>

            <!-- Detailed Statistics & Charts -->
            <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg border border-gray-200 mb-8">
                <h2 class="text-gray-800 mb-6">Detailed Statistics & Charts</h2>
                
                <!-- Equity Curve Chart -->
                <h3 class="text-gray-800 mb-4 mt-8">Equity Curve (Cumulative P&L)</h3>
                <div class="chart-container">
                    <canvas id="equityCurveChart"></canvas>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="detailed-stats-card">
                        <h4>Performance by Asset (Table)</h4>
                        <div id="performanceByAssetTable">
                            <p class="text-center text-gray-600">No asset data available.</p>
                        </div>
                    </div>
                    <div class="detailed-stats-card">
                        <h4>Performance by Trade Type (Table)</h4>
                        <div id="performanceByTradeTypeTable">
                            <p class="text-center text-gray-600">No trade type data available.</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="detailed-stats-card">
                        <h4>Performance by Asset (Chart)</h4>
                        <div class="chart-container">
                            <canvas id="assetPerformanceChart"></canvas>
                        </div>
                    </div>
                    <div class="detailed-stats-card">
                        <h4>Performance by Trade Type (Chart)</h4>
                        <div class="chart-container">
                            <canvas id="tradeTypePerformanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Key for local storage
        const LOCAL_STORAGE_KEY = 'tradingJournalEntries';

        // Array to store journal entries
        let journalEntries = [];
        // Variable to store the index of the entry being edited
        let editingEntryIndex = -1; 

        // Global variables for Chart.js instances
        let equityCurveChartInstance = null;
        let assetPerformanceChartInstance = null;
        let tradeTypePerformanceChartInstance = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Logic to show/hide custom pip value field in calculator
            const currencyPairSelect = document.getElementById('currencyPair');
            const customPipValueContainer = document.getElementById('customPipValueContainer');
            currencyPairSelect.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customPipValueContainer.style.display = 'block';
                } else {
                    customPipValueContainer.style.display = 'none';
                }
            });

            // Logic to show/hide custom asset input in journal
            const journalAssetSelect = document.getElementById('journalAssetSelect');
            const journalAssetCustomInput = document.getElementById('journalAssetCustom');
            journalAssetSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    journalAssetCustomInput.style.display = 'block';
                    journalAssetCustomInput.setAttribute('required', 'required'); // Make required when visible
                } else {
                    journalAssetCustomInput.style.display = 'none';
                    journalAssetCustomInput.removeAttribute('required'); // Remove required when hidden
                }
            });

            // Handle journal form submission
            const journalForm = document.getElementById('journalForm');
            journalForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent page reload
                if (editingEntryIndex === -1) {
                    addJournalEntry();
                } else {
                    updateJournalEntry();
                }
            });

            // Handle Cancel Edit button
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

            // Load entries from local storage on page load
            loadJournalEntries();
            applyFiltersAndSort(); // Apply filters and sort on load
        });

        // Function to save entries to local storage
        function saveJournalEntries() {
            console.log("Saving entries:", journalEntries); // Save log
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(journalEntries));
        }

        // Function to load entries from local storage
        function loadJournalEntries() {
            const storedEntries = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (storedEntries) {
                journalEntries = JSON.parse(storedEntries);
                console.log("Entries loaded:", journalEntries); // Load log
                // Ensure timestamps are Date objects for sorting if necessary
                journalEntries.forEach(entry => {
                    if (typeof entry.timestamp === 'string') {
                        entry.timestamp = new Date(entry.timestamp);
                    }
                });
            }
        }

        // Function to calculate position size
        function calculatePositionSize() {
            const capital = parseFloat(document.getElementById('capital').value);
            const riskPercentage = parseFloat(document.getElementById('riskPercentage').value);
            const stopLossPips = parseFloat(document.getElementById('stopLossPips').value);
            const currencyPair = document.getElementById('currencyPair').value;
            const calcErrorMessageDiv = document.getElementById('calcErrorMessage');
            const resultBox = document.getElementById('resultBox');

            // Hide previous messages and results
            calcErrorMessageDiv.classList.remove('show');
            resultBox.classList.remove('show');

            // Input validation
            if (isNaN(capital) || capital <= 0) {
                calcErrorMessageDiv.textContent = "Please enter a valid capital (> 0).";
                calcErrorMessageDiv.classList.add('show');
                return;
            }
            if (isNaN(riskPercentage) || riskPercentage <= 0 || riskPercentage > 100) {
                calcErrorMessageDiv.textContent = "Please enter a valid risk percentage (between 0.1 and 100).";
                calcErrorMessageDiv.classList.add('show');
                return;
            }
            if (isNaN(stopLossPips) || stopLossPips <= 0) {
                calcErrorMessageDiv.textContent = "Please enter a valid Stop Loss value (> 0).";
                calcErrorMessageDiv.classList.add('show');
                return;
            }

            let pipValuePerStandardLot; // Pip value for a standard lot (100,000 units) in EUR
            
            // Define pip value per standard lot based on the pair
            // These values are approximations for an EUR account.
            // For USD/JPY pairs, the value is for 100,000 base units (USD).
            // For indices, the value is per point.
            switch (currencyPair) {
                case 'EURUSD':
                case 'GBPUSD':
                case 'AUDUSD':
                case 'NZDUSD':
                    pipValuePerStandardLot = 10; // 1 pip = 10 USD for a standard lot, converted to EUR if account is in EUR
                    break;
                case 'USDJPY':
                    pipValuePerStandardLot = 8.5; // Approximation, depends on USD/JPY and EUR/USD exchange rates
                    break;
                case 'USDCAD':
                case 'USDCHF':
                    pipValuePerStandardLot = 10; // 1 pip = 10 USD for a standard lot, converted to EUR
                    break;
                case 'EURJPY':
                case 'GBPJPY':
                    pipValuePerStandardLot = 8.5; // Approximation, depends on JPY/EUR exchange rate
                    break;
                case 'XAUUSD': // Gold
                    pipValuePerStandardLot = 10; // 1 point = 10 USD for a standard lot (100 ounces), converted to EUR
                    break;
                case 'DAX40': // DAX 40
                case 'SP500': // S&P 500
                case 'NASDAQ100': // NASDAQ 100
                case 'CAC40': // CAC 40
                    pipValuePerStandardLot = 1; // 1 point = 1 EUR/USD for a standard lot (depends on broker)
                    break;
                case 'custom':
                    pipValuePerStandardLot = parseFloat(document.getElementById('customPipValue').value);
                    if (isNaN(pipValuePerStandardLot) || pipValuePerStandardLot <= 0) {
                        calcErrorMessageDiv.textContent = "Please enter a valid custom Pip/Point value (> 0).";
                        calcErrorMessageDiv.classList.add('show');
                        return;
                    }
                    break;
                default:
                    pipValuePerStandardLot = 10;
                    break;
            }

            const amountToRisk = (capital * riskPercentage) / 100;
            
            // Calculate position size in lots
            const lotSize = amountToRisk / (stopLossPips * pipValuePerStandardLot);

            document.getElementById('lotSize').textContent = lotSize.toFixed(2);
            document.getElementById('pipValueDisplay').textContent = pipValuePerStandardLot.toFixed(2);
            document.getElementById('amountRisqued').textContent = amountToRisk.toFixed(2);
            resultBox.classList.add('show');
        }

        // Function to add a journal entry
        function addJournalEntry() {
            const journalErrorMessageDiv = document.getElementById('journalErrorMessage');
            const newEntry = getJournalFormData();

            if (!newEntry) { // If validation failed in getJournalFormData
                journalErrorMessageDiv.classList.add('show');
                return;
            }

            journalErrorMessageDiv.classList.remove('show'); // Hide error if all is good

            newEntry.timestamp = new Date().toISOString(); // Timestamp for sorting
            journalEntries.unshift(newEntry); // Add new entry to the beginning of the array
            saveJournalEntries(); // Save entries after adding
            applyFiltersAndSort(); // Re-apply filters and sort to include the new entry
            document.getElementById('journalForm').reset(); // Reset the form
        }

        // Function to update an existing journal entry
        function updateJournalEntry() {
            console.log("Starting updateJournalEntry. editingEntryIndex:", editingEntryIndex); // Update start log
            const journalErrorMessageDiv = document.getElementById('journalErrorMessage');
            const updatedEntry = getJournalFormData();

            if (!updatedEntry) { // If validation failed
                journalErrorMessageDiv.classList.add('show');
                return;
            }

            journalErrorMessageDiv.classList.remove('show');

            // Update the existing entry
            if (editingEntryIndex !== -1 && journalEntries[editingEntryIndex]) {
                journalEntries[editingEntryIndex] = {
                    ...updatedEntry,
                    timestamp: journalEntries[editingEntryIndex].timestamp // Keep original timestamp
                };
                console.log("Entry updated in array:", journalEntries[editingEntryIndex]); // Updated entry log
                saveJournalEntries();
                applyFiltersAndSort(); // Re-apply filters and sort to reflect the modification
            } else {
                console.error("Error: invalid editingEntryIndex or entry not found.");
                journalErrorMessageDiv.textContent = "Error updating entry.";
                journalErrorMessageDiv.classList.add('show');
            }

            // Reset edit mode
            resetJournalForm();
        }

        // Function to get form data and validate it
        function getJournalFormData() {
            const journalDate = document.getElementById('journalDate').value;
            const journalAssetSelect = document.getElementById('journalAssetSelect');
            const journalAssetCustomInput = document.getElementById('journalAssetCustom');
            let journalAsset;

            if (journalAssetSelect.value === 'other') {
                journalAsset = journalAssetCustomInput.value;
            } else {
                journalAsset = journalAssetSelect.value;
            }

            const journalTradeType = document.getElementById('journalTradeType').value;
            const journalSetup = document.getElementById('journalSetup').value;
            const journalEntryPrice = parseFloat(document.getElementById('journalEntryPrice').value);
            const journalSL = parseFloat(document.getElementById('journalSL').value);
            const journalTP = parseFloat(document.getElementById('journalTP').value);
            const journalRRR = document.getElementById('journalRRR').value;
            const journalPositionSize = parseFloat(document.getElementById('journalPositionSize').value);
            const journalResultEuro = parseFloat(document.getElementById('journalResultEuro').value);
            const journalResultPercentage = parseFloat(document.getElementById('journalResultPercentage').value);
            const journalComment = document.getElementById('journalComment').value;
            const journalErrorMessageDiv = document.getElementById('journalErrorMessage');

            // Validation of required fields
            if (!journalDate || !journalAsset || isNaN(journalEntryPrice) || isNaN(journalSL) || isNaN(journalTP) || isNaN(journalPositionSize) || isNaN(journalResultEuro) || isNaN(journalResultPercentage)) {
                journalErrorMessageDiv.textContent = "Please fill in all required journal fields (those without placeholders).";
                console.log("Validation failed: missing or invalid fields."); // Validation log
                return null;
            }
            console.log("Form data retrieved and validated:", { journalDate, journalAsset, journalEntryPrice, journalResultEuro }); // Validated data log
            return {
                date: journalDate,
                asset: journalAsset,
                tradeType: journalTradeType,
                setup: journalSetup,
                entryPrice: journalEntryPrice,
                stopLoss: journalSL,
                takeProfit: journalTP,
                rrr: journalRRR,
                positionSize: journalPositionSize,
                resultEuro: journalResultEuro,
                resultPercentage: journalResultPercentage,
                comment: journalComment
            };
        }

        // Function to load entry data into the form for editing
        function editJournalEntry(index) {
            const entry = journalEntries[index];
            console.log("Starting editJournalEntry. Index:", index, "Entry:", entry); // Edit log
            document.getElementById('journalDate').value = entry.date;
            
            const journalAssetSelect = document.getElementById('journalAssetSelect');
            const journalAssetCustomInput = document.getElementById('journalAssetCustom');
            const assetOptions = Array.from(journalAssetSelect.options).map(option => option.value);

            if (assetOptions.includes(entry.asset)) {
                journalAssetSelect.value = entry.asset;
                journalAssetCustomInput.style.display = 'none';
                journalAssetCustomInput.removeAttribute('required');
            } else {
                journalAssetSelect.value = 'other';
                journalAssetCustomInput.value = entry.asset;
                journalAssetCustomInput.style.display = 'block';
                journalAssetCustomInput.setAttribute('required', 'required');
            }

            document.getElementById('journalTradeType').value = entry.tradeType;
            document.getElementById('journalSetup').value = entry.setup;
            document.getElementById('journalEntryPrice').value = entry.entryPrice;
            document.getElementById('journalSL').value = entry.stopLoss;
            document.getElementById('journalTP').value = entry.takeProfit;
            document.getElementById('journalRRR').value = entry.rrr;
            document.getElementById('journalPositionSize').value = entry.positionSize;
            document.getElementById('journalResultEuro').value = entry.resultEuro;
            document.getElementById('journalResultPercentage').value = entry.resultPercentage;
            document.getElementById('journalComment').value = entry.comment;

            editingEntryIndex = index; // Set the index of the entry being edited
            document.getElementById('addUpdateJournalBtn').textContent = 'Update Journal';
            document.getElementById('addUpdateJournalBtn').classList.remove('btn-secondary');
            document.getElementById('addUpdateJournalBtn').classList.add('btn-info'); // Change color to indicate modification
            document.getElementById('cancelEditBtn').style.display = 'block'; // Show Cancel button
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top of page
        }

        // Function to cancel editing and reset the form
        function cancelEdit() {
            console.log("Cancelling edit."); // Cancel log
            resetJournalForm();
        }

        // Function to reset the journal form and edit mode
        function resetJournalForm() {
            document.getElementById('journalForm').reset();
            document.getElementById('journalAssetCustom').style.display = 'none'; // Hide custom asset input
            document.getElementById('journalAssetCustom').removeAttribute('required'); // Remove required attribute
            editingEntryIndex = -1;
            document.getElementById('addUpdateJournalBtn').textContent = 'Add to Journal';
            document.getElementById('addUpdateJournalBtn').classList.remove('btn-info');
            document.getElementById('addUpdateJournalBtn').classList.add('btn-secondary');
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('journalErrorMessage').classList.remove('show');
            console.log("Form reset. editingEntryIndex:", editingEntryIndex); // Reset log
        }

        // Function to delete a journal entry
        function deleteJournalEntry(index) {
            // Use a custom confirmation modal instead of confirm()
            showCustomConfirm('Are you sure you want to delete this journal entry?', () => {
                console.log("Deleting entry at index:", index); // Delete log
                journalEntries.splice(index, 1); // Remove entry from array
                saveJournalEntries(); // Save changes
                applyFiltersAndSort(); // Re-apply filters and sort after deletion
                resetJournalForm(); // Reset form in case the deleted entry was being edited
            });
        }

        // Function to apply filters and sort, then render the journal
        function applyFiltersAndSort() {
            let filteredEntries = [...journalEntries]; // Copy to avoid modifying the original

            // 1. Filtering
            const filterAsset = document.getElementById('filterAsset').value.toLowerCase();
            const filterTradeType = document.getElementById('filterTradeType').value;

            if (filterAsset) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.asset.toLowerCase().includes(filterAsset)
                );
            }
            if (filterTradeType) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.tradeType === filterTradeType
                );
            }

            // 2. Sorting
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            filteredEntries.sort((a, b) => {
                let valA, valB;

                if (sortBy === 'timestamp') {
                    valA = new Date(a.timestamp).getTime();
                    valB = new Date(b.timestamp).getTime();
                } else if (sortBy === 'resultEuro' || sortBy === 'resultPercentage') {
                    valA = a[sortBy];
                    valB = b[sortBy];
                } else { // 'asset'
                    valA = a[sortBy].toLowerCase();
                    valB = b[sortBy].toLowerCase();
                }

                if (sortOrder === 'asc') {
                    if (valA < valB) return -1;
                    if (valA > valB) return 1;
                } else { // 'desc'
                    if (valA > valB) return -1;
                    if (valA < valB) return 1;
                }
                return 0;
            });

            renderFilteredJournalEntries(filteredEntries); // Render filtered and sorted entries
            updatePerformanceMetrics(filteredEntries); // Update metrics based on filtered entries
            updateDetailedPerformanceMetrics(filteredEntries); // Update detailed statistics and charts
        }

        // Function to reset filters and sort
        function resetFiltersAndSort() {
            document.getElementById('filterAsset').value = '';
            document.getElementById('filterTradeType').value = '';
            document.getElementById('sortBy').value = 'timestamp';
            document.getElementById('sortOrder').value = 'desc';
            applyFiltersAndSort(); // Apply default settings
        }

        // Function to display journal entries (filtered/sorted)
        function renderFilteredJournalEntries(entriesToRender) {
            console.log("Rendering filtered/sorted journal entries. Number of entries:", entriesToRender.length);
            const journalEntriesContainer = document.getElementById('journalEntriesContainer');
            const noEntriesMessage = document.getElementById('noEntriesMessage'); 

            journalEntriesContainer.innerHTML = ''; // Clear container

            if (entriesToRender.length > 0) {
                noEntriesMessage.style.display = 'none';
            } else {
                noEntriesMessage.style.display = 'block';
            }
            
            entriesToRender.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                
                const resultClass = entry.resultEuro >= 0 ? 'result-positive' : 'result-negative';

                entryDiv.innerHTML = `
                    <p><span class="label">Date:</span> <span class="value">${entry.date}</span></p>
                    <p><span class="label">Asset:</span> <span class="value">${entry.asset}</span> - <span class="value">${entry.tradeType}</span></p>
                    <p><span class="label">Setup:</span> <span class="value">${entry.setup || 'N/A'}</span></p>
                    <p><span class="label">Entry:</span> <span class="value">${entry.entryPrice}</span> | <span class="label">SL:</span> <span class="value">${entry.stopLoss}</span> | <span class="label">TP:</span> <span class="value">${entry.takeProfit}</span> | <span class="label">RRR:</span> <span class="value">${entry.rrr || 'N/A'}</span></p>
                    <p><span class="label">Position Size:</span> <span class="value">${entry.positionSize} lots</span></p>
                    <p class="text-lg font-bold ${resultClass}">Result: ${entry.resultEuro} € (${entry.resultPercentage}%)</p>
                    <p><span class="label">Comment:</span> <span class="value">${entry.comment || 'None'}</span></p>
                    <div class="journal-actions">
                        <button onclick="editJournalEntry(${journalEntries.indexOf(entry)})" class="btn-info">Edit</button>
                        <button onclick="deleteJournalEntry(${journalEntries.indexOf(entry)})" class="btn-danger">Delete</button>
                    </div>
                `;
                journalEntriesContainer.appendChild(entryDiv);
            });
        }

        // Function to update global performance statistics
        function updatePerformanceMetrics(entriesToCalculate) { // Takes entries to calculate (filtered or all)
            console.log("Updating global performance statistics...");
            const totalTrades = entriesToCalculate.length;
            let winningTrades = 0;
            let losingTrades = 0;
            let totalPnL = 0;
            let totalPnLPercentage = 0;
            let largestWin = 0;
            let largestLoss = 0; 

            entriesToCalculate.forEach(entry => {
                const resultEuro = entry.resultEuro;
                const resultPercentage = entry.resultPercentage;

                if (resultEuro > 0) {
                    winningTrades++;
                    if (resultEuro > largestWin) {
                        largestWin = resultEuro;
                    }
                } else if (resultEuro < 0) {
                    losingTrades++;
                    if (resultEuro < largestLoss) { 
                        largestLoss = resultEuro;
                    }
                }
                totalPnL += resultEuro;
                totalPnLPercentage += resultPercentage;
            });

            const winRate = totalTrades > 0 ? (winningTrades / totalTrades * 100).toFixed(2) : '0.00';
            const avgPnL = totalTrades > 0 ? (totalPnL / totalTrades).toFixed(2) : '0.00';

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winningTrades').textContent = winningTrades;
            document.getElementById('losingTrades').textContent = losingTrades;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('totalPnL').textContent = `${totalPnL.toFixed(2)} €`;
            document.getElementById('totalPnLPercentage').textContent = `${totalPnLPercentage.toFixed(2)}%`;
            document.getElementById('avgPnL').textContent = `${avgPnL} €`;
            document.getElementById('largestWin').textContent = `${largestWin.toFixed(2)} €`;
            document.getElementById('largestLoss').textContent = `${largestLoss.toFixed(2)} €`;

            // Update P&L metric colors based on result
            const totalPnLMetric = document.getElementById('totalPnLMetric');
            const totalPnLPercentageMetric = document.getElementById('totalPnLPercentageMetric');
            const avgPnLMetric = document.getElementById('avgPnLMetric');

            totalPnLMetric.classList.toggle('positive', totalPnL > 0);
            totalPnLMetric.classList.toggle('negative', totalPnL < 0);
            totalPnLPercentageMetric.classList.toggle('positive', totalPnLPercentage > 0);
            totalPnLPercentageMetric.classList.toggle('negative', totalPnLPercentage < 0);
            avgPnLMetric.classList.toggle('positive', parseFloat(avgPnL) > 0);
            avgPnLMetric.classList.toggle('negative', parseFloat(avgPnL) < 0);

            console.log("Global performance statistics updated.");
        }

        // Function to update detailed performance statistics and charts
        function updateDetailedPerformanceMetrics(entriesToCalculate) {
            console.log("Updating detailed performance statistics and charts...");
            const performanceByAsset = {};
            const performanceByTradeType = {};

            entriesToCalculate.forEach(entry => {
                // By Asset
                const asset = entry.asset.toUpperCase();
                if (!performanceByAsset[asset]) {
                    performanceByAsset[asset] = { totalTrades: 0, winningTrades: 0, totalPnL: 0, totalPnLPercentage: 0 };
                }
                performanceByAsset[asset].totalTrades++;
                if (entry.resultEuro > 0) {
                    performanceByAsset[asset].winningTrades++;
                }
                performanceByAsset[asset].totalPnL += entry.resultEuro;
                performanceByAsset[asset].totalPnLPercentage += entry.resultPercentage;

                // By Trade Type
                const tradeType = entry.tradeType;
                if (!performanceByTradeType[tradeType]) {
                    performanceByTradeType[tradeType] = { totalTrades: 0, winningTrades: 0, totalPnL: 0, totalPnLPercentage: 0 };
                }
                performanceByTradeType[tradeType].totalTrades++;
                if (entry.resultEuro > 0) {
                    performanceByTradeType[tradeType].winningTrades++;
                }
                performanceByTradeType[tradeType].totalPnL += entry.resultEuro;
                performanceByTradeType[tradeType].totalPnLPercentage += entry.resultPercentage;
            });

            // Render performance by asset (table)
            const assetContainer = document.getElementById('performanceByAssetTable');
            assetContainer.innerHTML = '';
            if (Object.keys(performanceByAsset).length === 0) {
                assetContainer.innerHTML = '<p class="text-center text-gray-600">No asset data available.</p>';
            } else {
                let assetTableHTML = `
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Trades</th>
                                <th>P&L (€)</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                for (const asset in performanceByAsset) {
                    const stats = performanceByAsset[asset];
                    const winRate = stats.totalTrades > 0 ? (stats.winningTrades / stats.totalTrades * 100).toFixed(2) : '0.00';
                    const pnLClass = stats.totalPnL >= 0 ? 'positive-text' : 'negative-text';
                    assetTableHTML += `
                        <tr>
                            <td>${asset}</td>
                            <td>${stats.totalTrades}</td>
                            <td class="${pnLClass}">${stats.totalPnL.toFixed(2)} €</td>
                            <td>${winRate}%</td>
                        </tr>
                    `;
                }
                assetTableHTML += `
                        </tbody>
                    </table>
                `;
                assetContainer.innerHTML = assetTableHTML;
            }

            // Render performance by trade type (table)
            const tradeTypeContainer = document.getElementById('performanceByTradeTypeTable');
            tradeTypeContainer.innerHTML = '';
            if (Object.keys(performanceByTradeType).length === 0) {
                tradeTypeContainer.innerHTML = '<p class="text-center text-gray-600">No trade type data available.</p>';
            } else {
                let tradeTypeTableHTML = `
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Trades</th>
                                <th>P&L (€)</th>
                                <th>Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                for (const type in performanceByTradeType) {
                    const stats = performanceByTradeType[type];
                    const winRate = stats.totalTrades > 0 ? (stats.winningTrades / stats.totalTrades * 100).toFixed(2) : '0.00';
                    const pnLClass = stats.totalPnL >= 0 ? 'positive-text' : 'negative-text';
                    tradeTypeTableHTML += `
                        <tr>
                            <td>${type}</td>
                            <td>${stats.totalTrades}</td>
                            <td class="${pnLClass}">${stats.totalPnL.toFixed(2)} €</td>
                            <td>${winRate}%</td>
                        </tr>
                    `;
                }
                tradeTypeTableHTML += `
                        </tbody>
                    </table>
                `;
                tradeTypeContainer.innerHTML = tradeTypeTableHTML;
            }
            console.log("Detailed statistics updated.");

            // Render charts
            renderEquityCurveChart(entriesToCalculate);
            renderAssetPerformanceChart(performanceByAsset);
            renderTradeTypePerformanceChart(performanceByTradeType);
        }

        // Function to render the equity curve chart
        function renderEquityCurveChart(entries) {
            const ctx = document.getElementById('equityCurveChart').getContext('2d');

            // Sort entries by date for the equity curve
            const sortedEntries = [...entries].sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = [];
            const cumulativePnL = [];
            let currentPnL = 0;

            sortedEntries.forEach(entry => {
                labels.push(entry.date);
                currentPnL += entry.resultEuro;
                cumulativePnL.push(currentPnL);
            });

            // Destroy old chart instance if it exists
            if (equityCurveChartInstance) {
                equityCurveChartInstance.destroy();
            }

            equityCurveChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cumulative P&L (€)',
                        data: cumulativePnL,
                        borderColor: '#6366f1', // Violet blue
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false, // Title already in H3
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'P&L (€)'
                            }
                        }
                    }
                }
            });
        }

        // Function to render asset performance chart
        function renderAssetPerformanceChart(data) {
            const ctx = document.getElementById('assetPerformanceChart').getContext('2d');

            const labels = Object.keys(data);
            const pnLValues = labels.map(label => data[label].totalPnL);

            const backgroundColors = pnLValues.map(value => value >= 0 ? '#10b981' : '#ef4444'); // Green for gain, red for loss

            // Destroy old chart instance if it exists
            if (assetPerformanceChartInstance) {
                assetPerformanceChartInstance.destroy();
            }

            assetPerformanceChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total P&L (€)',
                        data: pnLValues,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(color => color.replace('0.2', '1')), // Solid border
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false,
                        },
                        legend: {
                            display: false, // No legend needed for a single series with conditional colors
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Asset'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'P&L (€)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Function to render trade type performance chart
        function renderTradeTypePerformanceChart(data) {
            const ctx = document.getElementById('tradeTypePerformanceChart').getContext('2d');

            const labels = Object.keys(data);
            const pnLValues = labels.map(label => data[label].totalPnL);

            const backgroundColors = [
                '#3b82f6', // Blue for Buy
                '#f97316', // Orange for Sell
                '#6b7280' // Gray for other (if applicable)
            ]; // Specific colors for trade types

            // Destroy old chart instance if it exists
            if (tradeTypePerformanceChartInstance) {
                tradeTypePerformanceChartInstance.destroy();
            }

            tradeTypePerformanceChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total P&L (€)',
                        data: pnLValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false,
                        },
                        legend: {
                            display: true,
                            position: 'right',
                        }
                    }
                }
            });
        }


        // --- Custom confirmation modal (replaces alert/confirm) ---
        function showCustomConfirm(message, onConfirm) {
            const modalId = 'customConfirmModal';
            let modal = document.getElementById(modalId);

            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center z-50';
                modal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg font-semibold text-gray-800 mb-4" id="customConfirmMessage"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="confirmCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition">Cancel</button>
                            <button id="confirmOkBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">Confirm</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('customConfirmMessage').textContent = message;
            modal.style.display = 'flex'; // Show modal

            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');

            // Clean up old event listeners to prevent multiple calls
            const newConfirmOkBtn = confirmOkBtn.cloneNode(true);
            confirmOkBtn.parentNode.replaceChild(newConfirmOkBtn, confirmOkBtn);
            const newConfirmCancelBtn = confirmCancelBtn.cloneNode(true);
            confirmCancelBtn.parentNode.replaceChild(newConfirmCancelBtn, confirmCancelBtn);

            newConfirmOkBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                if (onConfirm) {
                    onConfirm();
                }
            });

            newConfirmCancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        // --- End of custom confirmation modal ---
    </script>
</body>
</html>